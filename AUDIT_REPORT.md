# AUDIT_REPORT.md - Отчет по аудиту проекта

**Дата:** 27.11.2025
**Аудитор:** Jules, Senior AI Engineering Auditor & Optimizer

## 1. Общее заключение

Проект обладает современной технологической базой (React, Vite, Supabase, Zustand) и в целом хорошо структурирован. Используются передовые практики, такие как абсолютные импорты (path aliases) и строгое разделение на фронтенд и бэкенд.

Однако, аудит выявил **критическую архитектурную проблему (P0)**, которая является системной и затрагивает ключевые модули приложения. Эта проблема — широкое использование антипаттерна **"God Object" / "God Component"**, когда один файл или модуль берет на себя слишком много ответственностей. Это приводит к высокой когнитивной сложности, делает код хрупким, трудным для тестирования и практически неподдерживаемым в долгосрочной перспективе.

План оптимизации должен быть в первую очередь сфокусирован на решении этой основной проблемы через декомпозицию и рефакторинг.

---

## 2. Классификация найденных проблем

### P0 — Критические проблемы

*   **Проблема:** Системный антипаттерн "God Object" в ключевых модулях.
    *   **Описание:** Основные функциональные части приложения — плеер, библиотека, генератор музыки и клиент для Suno API — реализованы в виде огромных монолитных файлов, нарушающих принцип единственной ответственности (Single Responsibility Principle).
    *   **Расположение:**
        *   `src/stores/audioPlayerStore.ts` (874 строки)
        *   `src/pages/workspace/Library.tsx` (848 строк)
        *   `src/components/generator/MusicGeneratorContainer.tsx` (768 строк)
        *   `supabase/functions/_shared/suno.ts` (1133 строки)
    *   **Риски:**
        *   **Хрупкость:** Любое изменение в одном из этих файлов может непредсказуемо затронуть другую часть его функциональности.
        *   **Сложность поддержки:** Новым разработчикам будет крайне сложно разобраться в логике этих модулей. Внесение изменений занимает неоправданно много времени.
        *   **Проблемы с тестированием:** Модули практически невозможно покрыть адекватными unit-тестами из-за их размера и количества зависимостей.
        *   **Потенциальные утечки памяти и проблемы с производительностью:** Сложное управление состоянием и побочными эффектами в одном месте часто приводит к ошибкам.

### P1 — Важные проблемы

*   **Проблема:** Смешение ответственности (Mixing Concerns) в state-менеджере.
    *   **Описание:** Глобальный стор плеера (`audioPlayerStore.ts`) содержит не только состояние UI, но и логику прямых асинхронных запросов к API (`_fetchVersionsFromApi`). Современные практики предполагают разделение состояния UI (Zustand) и состояния сервера (TanStack Query).
    *   **Расположение:** `src/stores/audioPlayerStore.ts`
    *   **Риски:**
        *   Отсутствие автоматического кеширования, инвалидации и фонового обновления данных, которые предоставляет TanStack Query.
        *   Усложнение логики стора, который должен управлять еще и состоянием запросов (loading, error).

### P2 — Желательные улучшения

*   **Проблема:** Избыточный проброс пропсов (Prop Drilling).
    *   **Описание:** В компонентах `Library.tsx` и `MusicGeneratorContainer.tsx` наблюдается передача большого количества пропсов в дочерние компоненты. Это делает компоненты сильно связанными и усложняет рефакторинг.
    *   **Расположение:** `src/pages/workspace/Library.tsx`, `src/components/generator/MusicGeneratorContainer.tsx`
    *   **Решение:** Использование React Context или композиции компонентов для более чистого предоставления зависимостей.

### P3 — Технический долг

*   **Проблема:** Большой, но автогенерируемый файл типов.
    *   **Описание:** Файл `src/integrations/supabase/types.ts` имеет огромный размер (2888 строк).
    *   **Анализ:** Это не является проблемой, так как файл генерируется автоматически на основе схемы БД Supabase и обеспечивает строгую типизацию. Ручной рефакторинг не требуется. Отмечен для полноты отчета.

---

## 3. Приоритетные направления для рефакторинга

1.  **Декомпозиция `suno.ts`:** Разбить API-клиент на модули по ресурсам (`generation`, `lyrics`, `stems`) и вынести типы в отдельный файл.
2.  **Рефакторинг `audioPlayerStore.ts`:** Разделить стор на логические "слайсы" (playback, queue, versions) и вынести data-fetching логику в хуки на базе TanStack Query.
3.  **Декомпозиция `MusicGeneratorContainer.tsx`:** Разбить монолитный контейнер на более мелкие, сфокусированные хуки и компоненты, возможно, с использованием React Context для управления состоянием формы.
4.  **Декомпозиция `Library.tsx`:** Разделить страницу на компоненты-блоки (`LibraryHeader`, `LibraryFilters`, `TrackGrid/List`) для уменьшения сложности и улучшения переиспользуемости.
