#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# ============================================
# Pre-commit Hook - Multi-System Validation
# ============================================

echo "ğŸ” Running pre-commit checks..."
echo ""

VALIDATION_PASSED=true

# ============================================
# 1. CSS Contract Validation
# ============================================

CSS_FILES_CHANGED=$(git diff --cached --name-only | grep -E "(index\.css|design-tokens\.css|tailwind\.config\.ts)")

if [ -n "$CSS_FILES_CHANGED" ]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“Š CSS files changed, validating contract..."
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Changed files:"
  echo "$CSS_FILES_CHANGED" | while read -r file; do
    echo "  - $file"
  done
  echo ""
  
  if ! bash scripts/validate-css-contract.sh; then
    VALIDATION_PASSED=false
    echo ""
    echo "âŒ CSS Contract validation failed!"
    echo "Read: docs/design-system/CSS_VARIABLE_CONTRACT.md"
    echo ""
  else
    echo "âœ… CSS Contract validation passed"
    echo ""
  fi
fi

# ============================================
# 2. Generation System Contract Validation
# ============================================

GEN_FILES_CHANGED=$(git diff --cached --name-only | grep -E "(services/generation|services/providers|provider-validation\.ts|generation-errors\.ts|supabase/functions/_shared/types/generation\.ts|supabase/functions/generate-)")

if [ -n "$GEN_FILES_CHANGED" ]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸµ Generation system files changed, validating contract..."
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Changed files:"
  echo "$GEN_FILES_CHANGED" | while read -r file; do
    echo "  - $file"
  done
  echo ""
  
  if ! bash scripts/validate-generation-contract.sh; then
    VALIDATION_PASSED=false
    echo ""
    echo "âŒ Generation System Contract validation failed!"
    echo "Read: docs/generation-system/DATA_CONTRACT.md"
    echo ""
  else
    echo "âœ… Generation System Contract validation passed"
    echo ""
  fi
fi

# ============================================
# Final Result
# ============================================

if [ "$VALIDATION_PASSED" = false ]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ COMMIT BLOCKED"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "One or more validation checks failed."
  echo "Please fix the errors above before committing."
  echo ""
  exit 1
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All pre-commit validations passed!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

exit 0
