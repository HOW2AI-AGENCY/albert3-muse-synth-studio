# Спринт 34: Подпись вебхуков Suno, архивирование треков и метрики

Даты: 15–22 ноября 2025  
Статус: Запланирован ⏳

## Цели
- Документировать и внедрить проверку подписи вебхуков (если Suno предоставляет заголовки подписи).
- Ввести поле `archived_at` для треков и учесть архивирование в очистке хранилища.
- Добавить интеграционные тесты для повторной доставки одного и того же вебхука.
- Настроить метрики/наблюдаемость: количество дублей, ошибок и время обработки.

## Backlog задач

| ID | Задача | Приоритет | Оценка (SP) | Ответственный | Критерии приёмки |
|---|---|---|---|---|---|
| S34-01 | Исследовать подпись вебхуков Suno: заголовки, схема HMAC | P1 | 3 | @oat70 | Документ с примерами заголовков и алгоритмом расчёта подписи |
| S34-02 | Реализовать проверку подписи в `generate-music-callb` | P1 | 5 | @oat70 | Валидация подписи, негативные тесты, обновлённые ответы при неверной подписи |
| S34-03 | Добавить `archived_at` в модель `tracks` (миграция) | P2 | 3 | @core-team | Миграция применена; поле задокументировано; обратная совместимость |
| S34-04 | Учесть `archived_at` в очистке Storage | P2 | 3 | @core-team | Файлы архивных треков исключены из удаления; тесты обновлены |
| S34-05 | Интеграционные тесты повторной доставки вебхука | P1 | 5 | @qa | Тесты подтверждают игнор дублей; отчёт в CI |
| S34-06 | Метрики webhook‑обработки (дубли, ошибки, время) | P2 | 5 | @devops | Дашборд/репорт; экспорты метрик; документация |
| S34-07 | Обновить документацию: `API_REFERENCE.md`, `webhooks.md` | P2 | 3 | @docs | Раздел подписи; примеры; диаграммы обновлены |

## План встреч

- Планирование: 2025‑11‑15 10:00–11:00 (UTC+3)
- Ежедневные стендапы: 2025‑11‑16 → 2025‑11‑22, 10:00–10:15
- Ретроспектива: 2025‑11‑22 17:00–18:00

## Риски
- Отсутствие официальных заголовков подписи от Suno — потребуется фоллбек стратегия.
- Потенциальные изменения схемы таблицы `tracks` (миграции и совместимость).

## Зависимости
- CI: `.github/workflows/supabase-functions-tests.yml`
- Edge функции: `supabase/functions/generate-music-callb/index.ts`, `supabase/functions/_shared/callback-processor.ts`
- Миграции: `supabase/migrations/*`