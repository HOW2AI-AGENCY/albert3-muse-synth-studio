# Sprint 31 Week 2: Critical Fixes & Lyrics Logging

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ë–∞–≥–∏

### 1. **–ê—É–¥–∏–æ –ü–ª–µ–µ—Ä - –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–ª–µ–µ—Ä –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–ª –∞—É–¥–∏–æ URL, –≤—ã–∑—ã–≤–∞—è –∑–∞–≤–∏—Å–∞–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.

**–ü—Ä–∏—á–∏–Ω–∞**:
- `useAudioUrlRefresh` –≤—ã–∑—ã–≤–∞–ª—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–µ –≤ `GlobalAudioPlayer.tsx`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è URL –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ refresh –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// src/hooks/useAudioUrlRefresh.ts
// ‚úÖ FIX: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ —á–∞—Å
if (now - lastCheckRef.current < URL_EXPIRY_CHECK_INTERVAL) {
  return;
}

// ‚úÖ FIX: –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ü–û–°–õ–ï –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
if (!isUrlExpired(audioUrl)) {
  lastCheckRef.current = now;
  return;
}

// ‚úÖ FIX: –£–¥–∞–ª–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ (checkAndRefresh() –ø—Ä–∏ mount)
// –¢–æ–ª—å–∫–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
```

```typescript
// src/components/player/GlobalAudioPlayer.tsx
// ‚úÖ FIX: –û–¢–ö–õ–Æ–ß–ò–õ–ò useAudioUrlRefresh (–¥—É–±–ª–∏—Ä–æ–≤–∞–ª –ª–æ–≥–∏–∫—É)
// Refresh –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ error handler (—Å—Ç—Ä–æ–∫–∞ 119-160)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –ü–ª–µ–µ—Ä –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç refresh –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è URL —Ç–æ–ª—å–∫–æ –∫–∞–∂–¥—ã–π —á–∞—Å
- ‚úÖ –ï–¥–∏–Ω–æ–µ –º–µ—Å—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏

---

## üÜï –ù–æ–≤–∞—è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: –°–∏—Å—Ç–µ–º–∞ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ì–µ–Ω–µ—Ä–∞—Ü–∏–π

### 2. **–ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö: –õ–æ–≥–∏ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¢–µ–∫—Å—Ç–æ–≤**

**–°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞** `lyrics_generation_log`:

```sql
CREATE TABLE public.lyrics_generation_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  prompt TEXT NOT NULL,
  generated_lyrics TEXT,
  generated_title TEXT,
  status TEXT NOT NULL DEFAULT 'pending' 
    CHECK (status IN ('pending', 'completed', 'failed')),
  error_message TEXT,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```

**–ò–Ω–¥–µ–∫—Å—ã** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞:
- `idx_lyrics_generation_log_user_id`
- `idx_lyrics_generation_log_status`
- `idx_lyrics_generation_log_created_at`

**RLS Policies**:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ª–æ–≥–∏
- ‚úÖ –ê–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –≤—Å–µ –ª–æ–≥–∏
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ –ª–æ–≥–∏

---

### 3. **Frontend: Hook –¥–ª—è –†–∞–±–æ—Ç—ã —Å –õ–æ–≥–∞–º–∏**

**–§–∞–π–ª**: `src/hooks/useLyricsGenerationLog.ts`

**–§—É–Ω–∫—Ü–∏–∏**:
```typescript
// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
useLyricsGenerationLog()

// –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Ç–∞—Ç—É—Å—É
useLyricsGenerationLogByStatus(status: 'pending' | 'completed' | 'failed')

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
useLyricsGenerationStats()
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { total, completed, failed, pending, successRate }
```

---

### 4. **UI: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ü—Ä–æ—Å–º–æ—Ç—Ä–∞ –õ–æ–≥–æ–≤**

**–ú–∞—Ä—à—Ä—É—Ç**: `/workspace/lyrics-log`

**–§–∞–π–ª**: `src/pages/workspace/LyricsGenerationLog.tsx`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
- üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤, —É—Å–ø–µ—à–Ω—ã—Ö, –æ—à–∏–±–æ–∫, % —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
- üîç **–ü–æ–∏—Å–∫**: –ü–æ –ø—Ä–æ–º–ø—Ç—É, —Ç–µ–∫—Å—Ç—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é
- üìù **–ö–∞—Ä—Ç–æ—á–∫–∏ –ª–æ–≥–æ–≤** —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
  - –°—Ç–∞—Ç—É—Å (–∏–∫–æ–Ω–∫–∞ + badge)
  - –ü—Ä–æ–º–ø—Ç
  - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä + –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç)
  - –û—à–∏–±–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  - –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
- üìú **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª** –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI**:
- Cards –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–≥–æ–≤
- Tabs (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä / –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç)
- Badges –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
- Skeleton –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
- ScrollArea –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤

---

## üìã –ü–ª–∞–Ω –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Edge Functions

### –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –û–±–Ω–æ–≤–∏—Ç—å `generate-lyrics` Edge Function

```typescript
// TODO: –î–æ–±–∞–≤–∏—Ç—å –≤ supabase/functions/generate-lyrics/index.ts

// 1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
const { data: logEntry } = await supabase
  .from('lyrics_generation_log')
  .insert({
    user_id: userId,
    prompt: requestPrompt,
    status: 'pending',
    metadata: { model: 'lovable-ai', requestId }
  })
  .select()
  .single();

// 2. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
await supabase
  .from('lyrics_generation_log')
  .update({
    status: 'completed',
    generated_lyrics: lyrics,
    generated_title: title,
  })
  .eq('id', logEntry.id);

// 3. –ü—Ä–∏ –æ—à–∏–±–∫–µ
await supabase
  .from('lyrics_generation_log')
  .update({
    status: 'failed',
    error_message: error.message,
  })
  .eq('id', logEntry.id);
```

---

## ‚úÖ Checklist

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–ª–µ–µ—Ä–∞
- [x] –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `lyrics_generation_log`
- [x] RLS Policies –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [x] Hook `useLyricsGenerationLog` —Å–æ–∑–¥–∞–Ω
- [x] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–∞
- [x] –ú–∞—Ä—à—Ä—É—Ç `/workspace/lyrics-log` –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Edge Function `generate-lyrics` (TODO)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏—é

---

## üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü–ª–µ–µ—Ä**:
1. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ç—Ä–µ–∫
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫ –∞—É–¥–∏–æ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Console Logs - –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∞—Å—Ç—ã—Ö refresh

**–õ–æ–≥–∏ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏**:
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ `/workspace/lyrics-log`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫
4. –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ Tabs
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç—É—Å—É (–ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ Week 2 Code Quality + Critical Fixes –∑–∞–≤–µ—Ä—à–µ–Ω—ã
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Edge Functions
