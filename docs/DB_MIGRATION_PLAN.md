# План управления миграциями и бэкапами БД (Supabase)

**Дата:** 27 ноября 2025 г.

## 1. Обзор

База данных PostgreSQL в Supabase является критически важным компонентом приложения. Любые изменения в ее схеме должны производиться контролируемо, с возможностью отката и без потери данных. Этот документ описывает рекомендуемый workflow.

## 2. Workflow работы с миграциями

Проект уже использует систему миграций Supabase CLI, что является правильным подходом. Все изменения схемы должны производиться **только через создание новых файлов миграций**.

### Шаги для внесения изменений в схему:

1.  **Убедитесь, что ваш локальный Supabase запущен:**
    ```bash
    npx supabase start
    ```

2.  **Создайте новый файл миграции:**
    ```bash
    npx supabase migration new <migration_name>
    ```
    *Пример: `npx supabase migration new add_user_profiles`*

3.  **Напишите SQL-код в созданном файле.** В файле миграции опишите изменения схемы данных (например, `CREATE TABLE`, `ALTER TABLE`, `CREATE POLICY`).

4.  **Примените миграцию к локальной базе данных:**
    ```bash
    npx supabase db reset
    ```
    *Эта команда полностью пересоздаст вашу локальную базу данных, применив все миграции с нуля, и запустит сиды (`supabase/seed.ts`). Это гарантирует, что ваши миграции работают корректно и консистентно.*

5.  **Закоммитьте новый файл миграции** в систему контроля версий (Git).

### Важные правила:

-   **НИКОГДА не редактируйте файлы существующих миграций**, которые уже были влиты в `develop` или `main`. Это может привести к рассинхронизации баз данных у разных разработчиков и на продакшене. Для отмены изменений создавайте новую миграцию, которая их отменяет.
-   **Всегда тестируйте миграции локально** с помощью `supabase db reset`, прежде чем отправлять их в Pull Request.

## 3. Стратегия резервного копирования (Backup)

Supabase автоматически создает ежедневные бэкапы для проектов на платных тарифах. Однако для дополнительной безопасности рекомендуется следующая стратегия:

1.  **Автоматические бэкапы Supabase:** Убедитесь, что для продакшен-окружения включены автоматические бэкапы в настройках проекта на платформе Supabase.
2.  **Бэкапы перед критическими изменениями:** Перед применением больших или рискованных миграций на продакшен-окружении **всегда создавайте бэкап вручную** через UI Supabase.
3.  **Локальные бэкапы (опционально, для разработки):**
    ```bash
    # Создать бэкап схемы
    npx supabase db dump --schema-only > schema.sql

    # Создать бэкап данных
    npx supabase db dump --data-only > data.sql
    ```

## 4. План отката (Rollback)

### Откат изменений схемы

-   **На продакшене:** Самый безопасный способ — **восстановление из бэкапа**, сделанного непосредственно перед применением миграции.
-   **На локальном окружении:** Если вы внесли некорректные изменения, самый простой способ — сбросить локальную базу до последней коммиченной версии:
    ```bash
    # Отменить изменения в файле миграции
    git restore supabase/migrations/<your_migration_file>.sql

    # Пересоздать базу
    npx supabase db reset
    ```
-   **"Откатывающая" миграция:** Если необходимо отменить изменения, которые уже попали в `main`, создайте новую миграцию, которая отменяет предыдущую (например, `DROP TABLE`, `ALTER TABLE ... DROP COLUMN`).

## 5. Рекомендации

-   **Тестирование миграций в CI:** Рассмотреть возможность добавления в CI/CD пайплайн шага, который запускает `supabase db reset` в Docker-контейнере, чтобы автоматически проверять синтаксис и консистентность миграций.
-   **Хранение бэкапов:** Определить политику хранения и местоположение ручных бэкапов (например, в защищенном S3-бакете).
-   **Документация:** Все сложные миграции должны быть подробно описаны в Pull Request.
