# üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è: –°–∏—Å—Ç–µ–º–∞ –ª–∞–π–∫–æ–≤ –¥–ª—è –≤–µ—Ä—Å–∏–π —Ç—Ä–µ–∫–æ–≤

**–î–∞—Ç–∞:** 2025-11-04  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

---

## üìã –û–±–∑–æ—Ä

–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º—É –ª–∞–π–∫–æ–≤ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤–µ—Ä—Å–∏–π —Ç—Ä–µ–∫–æ–≤ –≤–º–µ—Å—Ç–æ –ª–∞–π–∫–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤—Å–µ–≥–æ —Ç—Ä–µ–∫–∞.

### –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
- –õ–∞–π–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º—É —Ç—Ä–µ–∫—É —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `track_likes`
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏ –ª–∞–π–∫ –æ—Å—Ç–∞–µ—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –¥–ª—è –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é

### –†–µ—à–µ–Ω–∏–µ:
- –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `track_version_likes` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∞–π–∫–æ–≤ –≤–µ—Ä—Å–∏–π
- –ü–æ–ª–µ `like_count` –≤ —Ç–∞–±–ª–∏—Ü–µ `track_versions`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
- Helper-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ª–∞–π–∫–æ–≤

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://supabase.com/dashboard)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –û—Ç–∫—Ä–æ–π—Ç–µ **SQL Editor**
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `supabase/migrations/20251104000000_add_track_version_likes.sql`
5. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ **Run**

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Supabase CLI

```bash
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å–≤—è–∑–∞–Ω
supabase link --project-ref <YOUR_PROJECT_REF>

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
supabase db push

# 3. –†–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–∏–ø—ã TypeScript
npx supabase gen types typescript --project-id <YOUR_PROJECT_ID> > src/integrations/supabase/types.ts
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-–∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É `track_version_likes`
2. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ `like_count` –≤ `track_versions`
3. –°–æ–∑–¥–∞–π—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä-—Ñ—É–Ω–∫—Ü–∏—é `update_version_likes_count()`
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
5. –°–æ–∑–¥–∞–π—Ç–µ helper-—Ñ—É–Ω–∫—Ü–∏—é `is_version_liked()`
6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ `like_count = 0` –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤–µ—Ä—Å–∏–π

---

## üìä –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ö–µ–º–µ

### –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: `track_version_likes`

```sql
CREATE TABLE public.track_version_likes (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  version_id UUID NOT NULL REFERENCES track_versions(id),
  created_at TIMESTAMPTZ NOT NULL,
  UNIQUE(user_id, version_id)
);
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã: `track_versions`

```sql
ALTER TABLE track_versions 
ADD COLUMN like_count INTEGER DEFAULT 0 NOT NULL;
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
```sql
SELECT table_name, column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'track_version_likes';
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 4 —Å—Ç—Ä–æ–∫–∏ (id, user_id, version_id, created_at)

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞
```sql
SELECT trigger_name, event_manipulation 
FROM information_schema.triggers 
WHERE event_object_table = 'track_version_likes';
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —Ç—Ä–∏–≥–≥–µ—Ä `update_version_likes_count_trigger`

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS
```sql
SELECT tablename, policyname 
FROM pg_policies 
WHERE tablename = 'track_version_likes';
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 3 –ø–æ–ª–∏—Ç–∏–∫–∏

### 4. –¢–µ—Å—Ç–æ–≤—ã–π –ª–∞–π–∫
```sql
-- –í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ª–∞–π–∫ (–∑–∞–º–µ–Ω–∏—Ç–µ UUID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ)
INSERT INTO track_version_likes (user_id, version_id)
VALUES ('<USER_UUID>', '<VERSION_UUID>');

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
SELECT like_count FROM track_versions WHERE id = '<VERSION_UUID>';
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: `like_count` —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 1

---

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –æ—Ç–∫–∞—Ç:

```sql
-- 1. –£–¥–∞–ª–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä
DROP TRIGGER IF EXISTS update_version_likes_count_trigger ON track_version_likes;

-- 2. –£–¥–∞–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
DROP FUNCTION IF EXISTS public.update_version_likes_count();
DROP FUNCTION IF EXISTS public.is_version_liked(UUID, UUID);

-- 3. –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
DROP TABLE IF EXISTS public.track_version_likes;

-- 4. –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ
ALTER TABLE public.track_versions DROP COLUMN IF EXISTS like_count;
```

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

1. **–†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã TypeScript:**
   ```bash
   npx supabase gen types typescript --project-id <PROJECT_ID> > src/integrations/supabase/types.ts
   ```

2. **–û–±–Ω–æ–≤–∏—Ç—å LikesService** - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–µ—Ä—Å–∏—è–º–∏ (—É–∂–µ –≥–æ—Ç–æ–≤–æ)

3. **–°–æ–∑–¥–∞—Ç—å —Ö—É–∫ `useTrackVersionLike`** - –∞–Ω–∞–ª–æ–≥ `useTrackLike` –¥–ª—è –≤–µ—Ä—Å–∏–π

4. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ –ª–∞–π–∫–∏ –≤ `TrackCard`

5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ dev/staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- –ú–∏–≥—Ä–∞—Ü–∏—è **–æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞** - —Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–∞–π–∫–æ–≤ —Ç—Ä–µ–∫–æ–≤ (`track_likes`) –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- `like_count` –≤ —Ç–∞–±–ª–∏—Ü–µ `tracks` –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º
- –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–∞–π–∫–∏
- –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–∞–π–∫–∏ –Ω–∞ master-–≤–µ—Ä—Å–∏–∏

---

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞: "relation track_version_likes already exists"
–¢–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞. –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ –µ–µ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º.

### –û—à–∏–±–∫–∞: "column like_count already exists"
–ü–æ–ª–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ.

### –¢–∏–ø—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `project-id`.

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é  
**–°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `supabase/migrations/20251104000000_add_track_version_likes.sql`
- `src/services/likes.service.ts`
