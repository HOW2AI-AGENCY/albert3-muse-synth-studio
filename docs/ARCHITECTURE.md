# Архитектура Albert3 Muse Synth Studio

Этот документ описывает ключевые архитектурные решения фронтенда, а также обновления по интеграции с Supabase, логированию и работе с конфигурацией окружения.

## Общая структура
- **`src/config`** — единая точка для конфигурации приложения и валидации переменных окружения.
- **`src/integrations`** — клиенты внешних сервисов. В частности, `supabase/client.ts` предоставляет фабрику для создания типизированного клиента Supabase.
- **`src/services`** — слой бизнес-логики и работы с API. `api.service.ts` агрегирует операции над треками, провайдерами и вспомогательными функциями.
- **`src/utils`** — вспомогательные утилиты (логирование, кэширование и т.д.).

## Конфигурация окружения
Используется модуль `src/config/env.ts`, который валидирует необходимые переменные при запуске приложения через `zod`.

```ts
import { appEnv } from "@/config/env";
console.log(appEnv.supabaseUrl);
```

При отсутствии критичных переменных приложение не стартует, что предотвращает скрытые ошибки в рантайме.

## Интеграция с Supabase
- Клиент создаётся через `createSupabaseClient`, где корректно обрабатывается доступ к `localStorage` в средах без `window`.
- В клиент добавляются диагностические заголовки (`x-app-environment`), что упрощает трассировку запросов.
- Для интеграции с Edge Function введён набор хелперов (`src/services/api/errors.ts`), обеспечивающих единый формат обработки ошибок и логирования.

## Логирование
- `src/utils/logger.ts` теперь безопасно работает в средах без браузера (Node, тесты) и не вызывает ошибки при отсутствии `window`/`navigator`.
- Добавлены уровни логирования и контекст, что позволяет фильтровать сообщения и диагностировать проблемы в цепочке вызовов.
- В `api.service.ts` все операции используют централизованный логгер и формируют структурированные полезные нагрузки.

## Кэширование треков
`trackCache` продолжает использоваться как локальный кэш для завершённых треков. В случае ошибок API сервис автоматически пытается вернуть данные из кэша, что повышает устойчивость интерфейса.

## Обработка ошибок
- Для вызовов PostgREST и Edge Function используются `handlePostgrestError`, `handleSupabaseFunctionError` и `ensureData`, выбрасывающие типизированный `ApiError` с дополнительным контекстом.
- Это упрощает отладку и позволяет повторно использовать общий механизм обработки ошибок в будущем (например, для отображения уведомлений пользователю).

## Рекомендации по расширению
1. **Новые функции API** добавляйте через `ApiService`, используя существующие хелперы для обработки ошибок.
2. **Глобальные настройки** держите в `src/config`, чтобы исключить дублирование логики чтения `import.meta.env`.
3. **Тестирование**: добавление юнит-тестов для сервисов можно упростить, внедрив зависимость `createSupabaseClient` (см. экспорт фабрики в `supabase/client.ts`).
4. **Мониторинг**: при интеграции с внешними системами логирования используйте `logger.sendToServer` как единую точку расширения.

Документ следует обновлять при изменении ключевых архитектурных решений, чтобы команда имела актуальное представление о проекте.
