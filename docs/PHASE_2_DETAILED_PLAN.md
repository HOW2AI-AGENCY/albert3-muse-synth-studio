# üöÄ PHASE 2: Advanced UX & Features - –î–µ—Ç–∞–ª—å–Ω—ã–π –ü–ª–∞–Ω
**–í–µ—Ä—Å–∏—è:** 2.0  
**–î–∞—Ç–∞:** 02.11.2025  
**–ù–∞—á–∞–ª–æ:** Week 3-4 (–ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Phase 1)

---

## üìã Executive Summary

**Phase 2** —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ **–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö UX-—É–ª—É—á—à–µ–Ω–∏—è—Ö** –∏ **–Ω–æ–≤—ã—Ö —Ñ–∏—á–∞—Ö**, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–≤—ã—Å—è—Ç –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∫–∞—á–µ—Å—Ç–≤–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.

### üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏:
1. ‚ú® –°–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥ –≤—Ö–æ–¥–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (Onboarding)
2. üé® –î–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
3. üìä –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. üé≠ –î–æ–±–∞–≤–∏—Ç—å —É–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ AI

---

## üß≠ Task 2.1: Smart Onboarding Flow

### üìù –û–ø–∏—Å–∞–Ω–∏–µ
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç—É—Ä –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `react-joyride`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ–¥–µ—Ç —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### ‚úÖ Acceptance Criteria
- [ ] –¢—É—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `localStorage` + DB)
- [ ] 4-5 —à–∞–≥–æ–≤: Generator ‚Üí Prompt Input ‚Üí Provider Selector ‚Üí Library ‚Üí Player
- [ ] –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç—É—Ä –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
- [ ] Progress indicator (—à–∞–≥ X –∏–∑ Y)
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤ `user_preferences` —Ç–∞–±–ª–∏—Ü–µ
- [ ] –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ mobile/desktop)

### üìÅ –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

#### 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç—É—Ä–∞
```typescript
// src/components/onboarding/OnboardingTour.tsx

import Joyride, { Step, CallBackProps } from 'react-joyride';
import { useState, useEffect } from 'react';
import { useOnboardingStore } from '@/stores/useOnboardingStore';
import { supabase } from '@/integrations/supabase/client';

const TOUR_STEPS: Step[] = [
  {
    target: '#generator-prompt',
    content: (
      <div className="space-y-2">
        <h3 className="font-bold text-lg">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
        <p>–ù–∞—á–Ω–∏—Ç–µ —Å –æ–ø–∏—Å–∞–Ω–∏—è –º—É–∑—ã–∫–∏, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä: "—ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –º—É–∑—ã–∫–∞ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏"</p>
      </div>
    ),
    placement: 'bottom',
    disableBeacon: true,
  },
  {
    target: '#generator-provider',
    content: (
      <div className="space-y-2">
        <h3 className="font-bold text-lg">üéµ –í—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</h3>
        <p><strong>Suno</strong> - –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º—É–∑—ã–∫–∏ —Å –≤–æ–∫–∞–ª–æ–º</p>
        <p><strong>Mureka</strong> - –ª—É—á—à–µ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –º—É–∑—ã–∫–∏</p>
      </div>
    ),
    placement: 'right',
  },
  {
    target: '#generator-generate-btn',
    content: (
      <div className="space-y-2">
        <h3 className="font-bold text-lg">‚ú® –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</h3>
        <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–π–º–µ—Ç 2-3 –º–∏–Ω—É—Ç—ã.</p>
        <p className="text-sm text-muted-foreground">–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ —Ç—Ä–µ–∫ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤</p>
      </div>
    ),
    placement: 'top',
  },
  {
    target: '#library-link',
    content: (
      <div className="space-y-2">
        <h3 className="font-bold text-lg">üìö –í–∞—à–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</h3>
        <p>–í—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å. –í—ã —Å–º–æ–∂–µ—Ç–µ:</p>
        <ul className="list-disc list-inside text-sm">
          <li>–ü—Ä–æ—Å–ª—É—à–∏–≤–∞—Ç—å –∏ —Å–∫–∞—á–∏–≤–∞—Ç—å</li>
          <li>–†–∞–∑–¥–µ–ª—è—Ç—å –Ω–∞ —Å—Ç–µ–º—ã</li>
          <li>–°–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞–≤–µ—Ä-–≤–µ—Ä—Å–∏–∏</li>
          <li>–ü—Ä–æ–¥–ª–µ–≤–∞—Ç—å —Ç—Ä–µ–∫–∏</li>
        </ul>
      </div>
    ),
    placement: 'right',
  },
  {
    target: '#audio-player',
    content: (
      <div className="space-y-2">
        <h3 className="font-bold text-lg">üéß –ü–ª–µ–µ—Ä</h3>
        <p>–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –ø–ª–µ–µ—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ —Ç—Ä–µ–∫–∞</p>
        <p className="text-sm text-muted-foreground">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏—è–º–∏ –∏ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫—É –≥—Ä–æ–º–∫–æ—Å—Ç–∏</p>
      </div>
    ),
    placement: 'top',
  },
];

export const OnboardingTour = () => {
  const [run, setRun] = useState(false);
  const { markCompleted, isCompleted } = useOnboardingStore();

  useEffect(() => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç—É—Ä
    const checkOnboarding = async () => {
      const completed = await isCompleted();
      if (!completed) {
        // –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
        setTimeout(() => setRun(true), 1000);
      }
    };

    checkOnboarding();
  }, [isCompleted]);

  const handleCallback = async (data: CallBackProps) => {
    const { status, type } = data;

    if (status === 'finished' || status === 'skipped') {
      await markCompleted();
      setRun(false);
    }
  };

  return (
    <Joyride
      steps={TOUR_STEPS}
      run={run}
      continuous
      showProgress
      showSkipButton
      callback={handleCallback}
      styles={{
        options: {
          primaryColor: 'hsl(var(--primary))',
          zIndex: 10000,
        },
        tooltip: {
          borderRadius: 'var(--radius-lg)',
          padding: '1.5rem',
        },
        buttonNext: {
          backgroundColor: 'hsl(var(--primary))',
          borderRadius: 'var(--radius-md)',
          padding: '0.5rem 1rem',
        },
        buttonSkip: {
          color: 'hsl(var(--muted-foreground))',
        },
      }}
    />
  );
};
```

#### 2. Zustand Store –¥–ª—è onboarding
```typescript
// src/stores/useOnboardingStore.ts

import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { supabase } from '@/integrations/supabase/client';

interface OnboardingState {
  completedSteps: string[];
  isCompleted: () => Promise<boolean>;
  markCompleted: () => Promise<void>;
  resetOnboarding: () => void;
}

export const useOnboardingStore = create<OnboardingState>()(
  persist(
    (set, get) => ({
      completedSteps: [],

      isCompleted: async () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
        const localCompleted = localStorage.getItem('onboarding_completed') === 'true';
        if (localCompleted) return true;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º DB
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return false;

        const { data, error } = await supabase
          .from('user_preferences')
          .select('onboarding_completed')
          .eq('user_id', user.id)
          .single();

        return data?.onboarding_completed || false;
      },

      markCompleted: async () => {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('onboarding_completed', 'true');

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ DB
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        await supabase
          .from('user_preferences')
          .upsert({
            user_id: user.id,
            onboarding_completed: true,
            updated_at: new Date().toISOString(),
          });

        set({ completedSteps: ['all'] });
      },

      resetOnboarding: () => {
        localStorage.removeItem('onboarding_completed');
        set({ completedSteps: [] });
      },
    }),
    {
      name: 'onboarding-storage',
    }
  )
);
```

#### 3. Migration –¥–ª—è user_preferences
```sql
-- Migration: 20251102000001_add_onboarding_preferences.sql

-- –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É onboarding_completed –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
ALTER TABLE user_preferences 
ADD COLUMN IF NOT EXISTS onboarding_completed BOOLEAN DEFAULT false;

-- –ò–ª–∏ —Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
CREATE TABLE IF NOT EXISTS user_preferences (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  theme_accent_color TEXT DEFAULT '#818cf8',
  theme_density TEXT DEFAULT 'comfortable',
  onboarding_completed BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS Policies
ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own preferences"
  ON user_preferences FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own preferences"
  ON user_preferences FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own preferences"
  ON user_preferences FOR UPDATE
  USING (auth.uid() = user_id);
```

#### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ App.tsx
```typescript
// src/App.tsx

import { OnboardingTour } from '@/components/onboarding/OnboardingTour';

function App() {
  return (
    <>
      {/* ... existing routes */}
      
      {/* Onboarding Tour - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */}
      <OnboardingTour />
    </>
  );
}
```

### üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
npm install react-joyride@^2.8.2
```

### üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
- [ ] ‚â•70% –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≤–µ—Ä—à–∞—é—Ç —Ç—É—Ä
- [ ] ‚â§2 –º–∏–Ω—É—Ç—ã –Ω–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ
- [ ] ‚â•80% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç —Ç—Ä–µ–∫ –ø–æ—Å–ª–µ —Ç—É—Ä–∞

---

## üé® Task 2.2: Theme Customization

### üìù –û–ø–∏—Å–∞–Ω–∏–µ
–°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –≤—ã–±–æ—Ä –∞–∫—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞, –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ spacing, —Ç–µ–º–Ω–æ–π/—Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã.

### ‚úÖ Acceptance Criteria
- [ ] 4 –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤—ã—Ö —Ç–µ–º—ã (Purple, Blue, Pink, Green)
- [ ] 3 —Ä–µ–∂–∏–º–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ (Compact, Comfortable, Spacious)
- [ ] Live preview –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ DB + localStorage –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
- [ ] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `document.documentElement.style`
- [ ] –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π UI (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)

### üìÅ –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

#### 1. Theme Customizer Component
```typescript
// src/components/settings/ThemeCustomizer.tsx

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Check } from '@/utils/iconImports';
import { cn } from '@/lib/utils';
import { useThemeStore } from '@/stores/useThemeStore';

const COLOR_PRESETS = [
  { name: 'Purple', value: '#818cf8', hsl: '262 83% 58%' },
  { name: 'Blue', value: '#0ea5e9', hsl: '189 94% 43%' },
  { name: 'Pink', value: '#ec4899', hsl: '330 81% 60%' },
  { name: 'Green', value: '#10b981', hsl: '142 76% 36%' },
];

const DENSITY_OPTIONS = [
  { 
    value: 'compact', 
    label: '–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π', 
    description: '75% –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ',
    spacing: '0.75' 
  },
  { 
    value: 'comfortable', 
    label: '–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π', 
    description: '100% - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
    spacing: '1' 
  },
  { 
    value: 'spacious', 
    label: '–ü—Ä–æ—Å—Ç–æ—Ä–Ω—ã–π', 
    description: '125% –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ',
    spacing: '1.25' 
  },
];

export const ThemeCustomizer = () => {
  const { accentColor, density, setAccentColor, setDensity, saveToDb } = useThemeStore();
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

  // Apply theme changes to CSS
  useEffect(() => {
    const selectedPreset = COLOR_PRESETS.find(p => p.value === accentColor);
    if (selectedPreset) {
      document.documentElement.style.setProperty('--color-primary', selectedPreset.hsl);
    }
  }, [accentColor]);

  useEffect(() => {
    const densityValue = DENSITY_OPTIONS.find(d => d.value === density)?.spacing || '1';
    document.documentElement.style.setProperty('--density-scale', densityValue);
    
    // Apply to spacing multiplier
    document.documentElement.setAttribute('data-density', density);
  }, [density]);

  const handleColorChange = (color: string) => {
    setAccentColor(color);
    setHasUnsavedChanges(true);
  };

  const handleDensityChange = (newDensity: string) => {
    setDensity(newDensity as 'compact' | 'comfortable' | 'spacious');
    setHasUnsavedChanges(true);
  };

  const handleSave = async () => {
    await saveToDb();
    setHasUnsavedChanges(false);
  };

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            üé® –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
            {hasUnsavedChanges && (
              <Badge variant="secondary" className="ml-auto">
                –ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
              </Badge>
            )}
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Color Picker */}
          <div className="space-y-3">
            <Label className="text-sm font-medium">–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</Label>
            <div className="grid grid-cols-4 gap-3">
              {COLOR_PRESETS.map((preset) => (
                <button
                  key={preset.value}
                  onClick={() => handleColorChange(preset.value)}
                  className={cn(
                    'relative h-20 rounded-lg border-2 transition-all hover:scale-105',
                    accentColor === preset.value 
                      ? 'border-foreground shadow-lg' 
                      : 'border-border hover:border-foreground/50'
                  )}
                  style={{ backgroundColor: preset.value }}
                >
                  {accentColor === preset.value && (
                    <div className="absolute inset-0 flex items-center justify-center">
                      <Check className="w-6 h-6 text-white drop-shadow-lg" />
                    </div>
                  )}
                  <div className="absolute bottom-1 left-0 right-0 text-center">
                    <span className="text-xs font-medium text-white drop-shadow">
                      {preset.name}
                    </span>
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* Density Toggle */}
          <div className="space-y-3">
            <Label className="text-sm font-medium">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</Label>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              {DENSITY_OPTIONS.map((option) => (
                <Button
                  key={option.value}
                  variant={density === option.value ? 'default' : 'outline'}
                  className="h-auto py-4 flex flex-col items-start gap-1"
                  onClick={() => handleDensityChange(option.value)}
                >
                  <span className="font-semibold">{option.label}</span>
                  <span className="text-xs text-muted-foreground">
                    {option.description}
                  </span>
                </Button>
              ))}
            </div>
          </div>

          {/* Preview */}
          <div className="space-y-3">
            <Label className="text-sm font-medium">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</Label>
            <div 
              className="p-4 rounded-lg border bg-card"
              style={{ 
                borderColor: accentColor,
                transform: `scale(${density === 'compact' ? '0.9' : density === 'spacious' ? '1.1' : '1'})`
              }}
            >
              <h3 className="font-semibold mb-2" style={{ color: accentColor }}>
                –ü—Ä–∏–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏
              </h3>
              <p className="text-sm text-muted-foreground mb-3">
                –¢–∞–∫ –±—É–¥—É—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
              </p>
              <Button size="sm" style={{ backgroundColor: accentColor }}>
                –ü—Ä–∏–º–µ—Ä –∫–Ω–æ–ø–∫–∏
              </Button>
            </div>
          </div>

          {/* Save Button */}
          {hasUnsavedChanges && (
            <Button onClick={handleSave} className="w-full">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </Button>
          )}
        </CardContent>
      </Card>
    </div>
  );
};
```

#### 2. Theme Store
```typescript
// src/stores/useThemeStore.ts

import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { supabase } from '@/integrations/supabase/client';

interface ThemeState {
  accentColor: string;
  density: 'compact' | 'comfortable' | 'spacious';
  setAccentColor: (color: string) => void;
  setDensity: (density: 'compact' | 'comfortable' | 'spacious') => void;
  loadFromDb: () => Promise<void>;
  saveToDb: () => Promise<void>;
}

export const useThemeStore = create<ThemeState>()(
  persist(
    (set, get) => ({
      accentColor: '#818cf8',
      density: 'comfortable',

      setAccentColor: (color) => set({ accentColor: color }),
      setDensity: (density) => set({ density }),

      loadFromDb: async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from('user_preferences')
          .select('theme_accent_color, theme_density')
          .eq('user_id', user.id)
          .single();

        if (data) {
          set({
            accentColor: data.theme_accent_color || '#818cf8',
            density: data.theme_density || 'comfortable',
          });
        }
      },

      saveToDb: async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { accentColor, density } = get();

        await supabase
          .from('user_preferences')
          .upsert({
            user_id: user.id,
            theme_accent_color: accentColor,
            theme_density: density,
            updated_at: new Date().toISOString(),
          });
      },
    }),
    {
      name: 'theme-storage',
    }
  )
);
```

### üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
- [ ] ‚â•40% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É—é—Ç —Ç–µ–º—É
- [ ] ‚â§5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [ ] 100% —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏

---

## üìä Task 2.3: User Analytics Dashboard

### üìù –û–ø–∏—Å–∞–Ω–∏–µ
–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤, –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è, –ª—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º.

### ‚úÖ Acceptance Criteria
- [ ] 4 KPI –∫–∞—Ä—Ç–æ—á–∫–∏: Total Tracks, Total Likes, Total Plays, Total Downloads
- [ ] 3 –≥—Ä–∞—Ñ–∏–∫–∞: Generation Trend (area chart), Top Genres (pie chart), Provider Usage (bar chart)
- [ ] Insights –±–ª–æ–∫ —Å AI-–ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
- [ ] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥—É (Last 7 days, Last 30 days, All time)
- [ ] –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è grid layout (responsive)

### üìÅ –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

#### 1. Analytics Page
```typescript
// src/pages/workspace/Analytics.tsx

import { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { 
  Music, 
  Heart, 
  PlayCircle, 
  Download,
  TrendingUp,
  TrendingDown
} from '@/utils/iconImports';
import { 
  AreaChart, 
  Area, 
  PieChart, 
  Pie, 
  BarChart, 
  Bar,
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer,
  Cell 
} from 'recharts';
import { useUserStats } from '@/hooks/useUserStats';

type Period = '7d' | '30d' | 'all';

export const Analytics = () => {
  const [period, setPeriod] = useState<Period>('30d');
  const { data: stats, isLoading } = useUserStats(period);

  if (isLoading) {
    return <LoadingState />;
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
          <p className="text-muted-foreground mt-1">
            –û–±–∑–æ—Ä –≤–∞—à–µ–π –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          </p>
        </div>

        <Tabs value={period} onValueChange={(v) => setPeriod(v as Period)}>
          <TabsList>
            <TabsTrigger value="7d">7 –¥–Ω–µ–π</TabsTrigger>
            <TabsTrigger value="30d">30 –¥–Ω–µ–π</TabsTrigger>
            <TabsTrigger value="all">–í—Å–µ –≤—Ä–µ–º—è</TabsTrigger>
          </TabsList>
        </Tabs>
      </div>

      {/* KPI Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <MetricCard
          icon={<Music />}
          label="–í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤"
          value={stats.totalTracks}
          trend={stats.tracksTrend}
          trendLabel="+12% –∑–∞ –º–µ—Å—è—Ü"
        />
        <MetricCard
          icon={<Heart />}
          label="–í—Å–µ–≥–æ –ª–∞–π–∫–æ–≤"
          value={stats.totalLikes}
          trend={stats.likesTrend}
          trendLabel="+5% –∑–∞ –º–µ—Å—è—Ü"
        />
        <MetricCard
          icon={<PlayCircle />}
          label="–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π"
          value={stats.totalPlays}
          trend={stats.playsTrend}
          trendLabel="+18% –∑–∞ –º–µ—Å—è—Ü"
        />
        <MetricCard
          icon={<Download />}
          label="–°–∫–∞—á–∏–≤–∞–Ω–∏–π"
          value={stats.totalDownloads}
          trend={stats.downloadsTrend}
          trendLabel="+8% –∑–∞ –º–µ—Å—è—Ü"
        />
      </div>

      {/* Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Generation Trend */}
        <Card>
          <CardHeader>
            <CardTitle>üìà –î–∏–Ω–∞–º–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</CardTitle>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={300}>
              <AreaChart data={stats.generationsByDay}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="date" />
                <YAxis />
                <Tooltip />
                <Area 
                  type="monotone" 
                  dataKey="count" 
                  stroke="hsl(var(--primary))" 
                  fill="hsl(var(--primary) / 0.2)" 
                />
              </AreaChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* Top Genres */}
        <Card>
          <CardHeader>
            <CardTitle>üéµ –¢–æ–ø –∂–∞–Ω—Ä—ã</CardTitle>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={300}>
              <PieChart>
                <Pie
                  data={stats.genreDistribution}
                  dataKey="count"
                  nameKey="genre"
                  cx="50%"
                  cy="50%"
                  outerRadius={100}
                  label
                >
                  {stats.genreDistribution.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip />
              </PieChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* Provider Usage */}
        <Card>
          <CardHeader>
            <CardTitle>‚ö° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤</CardTitle>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={stats.providerStats}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="provider" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="count" fill="hsl(var(--primary))" />
              </BarChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* Insights */}
        <Card>
          <CardHeader>
            <CardTitle>üí° –ò–Ω—Å–∞–π—Ç—ã</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {stats.insights.map((insight, idx) => (
                <div key={idx} className="flex items-start gap-2">
                  <span>{insight.icon}</span>
                  <p className="text-sm">{insight.text}</p>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

const MetricCard = ({ icon, label, value, trend, trendLabel }) => (
  <Card>
    <CardContent className="pt-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          {icon}
          <span className="text-sm text-muted-foreground">{label}</span>
        </div>
        {trend > 0 ? (
          <TrendingUp className="w-4 h-4 text-green-500" />
        ) : (
          <TrendingDown className="w-4 h-4 text-red-500" />
        )}
      </div>
      <div className="mt-3">
        <p className="text-3xl font-bold">{value.toLocaleString()}</p>
        <p className="text-xs text-muted-foreground mt-1">{trendLabel}</p>
      </div>
    </CardContent>
  </Card>
);
```

#### 2. useUserStats Hook
```typescript
// src/hooks/useUserStats.ts

import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { subDays, format } from 'date-fns';

export const useUserStats = (period: '7d' | '30d' | 'all') => {
  return useQuery({
    queryKey: ['user-stats', period],
    queryFn: async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const startDate = period === 'all' 
        ? new Date(0) 
        : subDays(new Date(), period === '7d' ? 7 : 30);

      // Fetch tracks
      const { data: tracks } = await supabase
        .from('tracks')
        .select('*')
        .eq('user_id', user.id)
        .gte('created_at', startDate.toISOString());

      // Aggregate stats
      const totalTracks = tracks?.length || 0;
      const totalLikes = tracks?.reduce((sum, t) => sum + (t.like_count || 0), 0) || 0;
      const totalPlays = tracks?.reduce((sum, t) => sum + (t.play_count || 0), 0) || 0;
      const totalDownloads = tracks?.reduce((sum, t) => sum + (t.download_count || 0), 0) || 0;

      // Generation trend (group by day)
      const generationsByDay = tracks?.reduce((acc, track) => {
        const date = format(new Date(track.created_at), 'dd MMM');
        const existing = acc.find(d => d.date === date);
        if (existing) {
          existing.count++;
        } else {
          acc.push({ date, count: 1 });
        }
        return acc;
      }, [] as Array<{ date: string; count: number }>);

      // Genre distribution
      const genreMap = new Map<string, number>();
      tracks?.forEach(track => {
        const genre = track.style_tags?.[0] || 'Unknown';
        genreMap.set(genre, (genreMap.get(genre) || 0) + 1);
      });
      const genreDistribution = Array.from(genreMap.entries())
        .map(([genre, count]) => ({ genre, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

      // Provider stats
      const providerStats = [
        { provider: 'Suno', count: tracks?.filter(t => t.provider === 'suno').length || 0 },
        { provider: 'Mureka', count: tracks?.filter(t => t.provider === 'mureka').length || 0 },
      ];

      // AI Insights
      const insights = [
        { icon: 'üé§', text: `–í—ã —á–∞—â–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç–µ —Ç—Ä–µ–∫–∏ —Å –≤–æ–∫–∞–ª–æ–º (${Math.round((tracks?.filter(t => t.has_vocals).length || 0) / totalTracks * 100)}%)` },
        { icon: 'üéµ', text: `–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∂–∞–Ω—Ä: ${genreDistribution[0]?.genre || 'N/A'} (${genreDistribution[0]?.count || 0} —Ç—Ä–µ–∫–æ–≤)` },
        { icon: '‚è∞', text: `–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: –≤–µ—á–µ—Ä (18-22)` },
      ];

      return {
        totalTracks,
        totalLikes,
        totalPlays,
        totalDownloads,
        tracksTrend: 12,
        likesTrend: 5,
        playsTrend: 18,
        downloadsTrend: 8,
        generationsByDay: generationsByDay || [],
        genreDistribution,
        providerStats,
        insights,
      };
    },
    staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
  });
};
```

### üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
- [ ] ‚â•30% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ç–∫—Ä—ã–≤–∞—é—Ç Analytics
- [ ] ‚â•10 —Å–µ–∫—É–Ω–¥ —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- [ ] ‚â•60% –∫–ª–∏–∫–∞—é—Ç –Ω–∞ insights

---

## üì¶ –û–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Phase 2

```json
{
  "react-joyride": "^2.8.2",
  "recharts": "^2.15.4",
  "date-fns": "^3.0.0"
}
```

---

## üìà Roadmap Phase 2

### Week 3 (Sprint 33)
- [ ] Day 1-2: Task 2.1 (Onboarding Tour) - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç + store + DB migration
- [ ] Day 3-4: Task 2.2 (Theme Customizer) - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç + store + CSS integration
- [ ] Day 5: Testing & Bug fixes

### Week 4 (Sprint 34)
- [ ] Day 1-3: Task 2.3 (Analytics Dashboard) - page + hook + charts
- [ ] Day 4: Integration testing –≤—Å–µ—Ö —Ñ–∏—á
- [ ] Day 5: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è + Deployment

---

## ‚úÖ Acceptance Criteria (Overall Phase 2)

- [ ] Onboarding Tour —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] Theme Customization —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏
- [ ] Analytics Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [ ] –í—Å–µ —Ñ–∏—á–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã (mobile + desktop)
- [ ] Unit tests coverage ‚â•70% –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] Lighthouse score ‚â•90
- [ ] –ù–µ—Ç performance regression (TTI ‚â§2s)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1 (High)  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** Phase 1 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞
