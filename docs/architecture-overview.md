# Обзор архитектуры приложения

Этот документ предоставляет детальный обзор архитектуры приложения, описывая ключевые компоненты и их взаимодействие.

## Общая философия

Приложение разработано с четким разделением между фронтендом и бэкендом, что обеспечивает модульность, масштабируемость и безопасность.

- **Фронтенд:** Отвечает за пользовательский интерфейс и взаимодействие с пользователем.
- **Бэкенд:** Управляет данными, бизнес-логикой и взаимодействием со сторонними сервисами.

## Технологический стек

- **Фронтенд:**
  - **React:** Библиотека для создания пользовательских интерфейсов.
  - **Vite:** Инструмент для сборки и разработки.
  - **TypeScript:** Типизированный язык программирования, повышающий надежность кода.
  - **Tailwind CSS:** CSS-фреймворк для быстрой стилизации.
  - **React Router:** Для навигации по приложению.
  - **React Query:** Для управления состоянием сервера и кэширования данных.

- **Бэкенд:**
  - **Supabase:** Платформа "Backend-as-a-Service" (BaaS), предоставляющая:
    - **PostgreSQL:** Реляционная база данных.
    - **Аутентификация:** Управление пользователями и доступом.
    - **Edge Functions:** Бессерверные функции на Deno для выполнения серверной логики.
    - **Хранилище:** Для хранения файлов, таких как аудио.

## Структура проекта

### Фронтенд (`src/`)

Фронтенд представляет собой самодостаточное React-приложение со следующей структурой:

- `main.tsx`: Точка входа, где инициализируется приложение.
- `App.tsx`: Корневой компонент, настраивающий маршрутизацию, провайдеры контекста и глобальные компоненты.
- `pages/`: Компоненты, соответствующие отдельным страницам (например, `Landing`, `Auth`, `Workspace`).
- `components/`: Переиспользуемые UI-компоненты (`кнопки`, `диалоги`, `формы`).
- `contexts/`: Провайдеры контекста для управления глобальным состоянием (например, `AudioPlayerContext`).
- `hooks/`: Пользовательские хуки для инкапсуляции логики.
- `services/`: Функции для взаимодействия с API бэкенда (Supabase).
- `utils/`: Вспомогательные утилиты.

### Бэкенд (`supabase/`)

Бэкенд построен на Supabase и имеет стандартную структуру:

- `migrations/`: SQL-миграции для управления схемой базы данных.
- `functions/`: Бессерверные Edge Functions, написанные на Deno/TypeScript. Каждая функция выполняет определенную задачу (например, `generate-music`, `get-balance`).
  - `_shared/`: Общий код, используемый несколькими функциями.
- `config.toml`: Конфигурационный файл Supabase.

## Взаимодействие фронтенда и бэкенда

Взаимодействие между фронтендом и бэкендом происходит исключительно через API:

1.  **Аутентификация:** Фронтенд использует клиентскую библиотеку Supabase (`@supabase/supabase-js`) для регистрации, входа и управления сессиями пользователей. Защищенные маршруты на фронтенде проверяют наличие действительного токена JWT.
2.  **Запросы данных:** Фронтенд запрашивает данные из базы данных PostgreSQL через API Supabase, соблюдая правила безопасности на уровне строк (Row Level Security, RLS).
3.  **Вызов бизнес-логики:** Для выполнения сложных или привилегированных операций (например, генерация музыки, обработка платежей) фронтенд вызывает соответствующие Edge Functions через их HTTPS-эндпоинты.

## Результаты аудита

Предоставленный пользователем аудит архитектуры сфокусировался на разделении ответственности между фронтендом и бэкендом и выделил несколько критичных UX-наблюдений. Ключевые выводы, подтверждаемые текущим состоянием кода, приведены ниже:

-   **Безопасность:**
    -   **Клиентская часть:** Фронтенд использует публичный ключ Supabase (`anon key`), при этом секретные токены остаются только на сервере. Политики RLS ограничивают доступ к данным в соответствии с правами пользователя.
    -   **Серверная часть:** Edge-функции Supabase требуют авторизации пользователя и дополнительно проверяют права владения ресурсами перед выполнением операций. Для чувствительных задач применяется сервисный ключ, который хранится в конфигурации Supabase.

-   **Надежность:**
    -   **Обработка ошибок:** Логика запросов инкапсулирована в `ApiService`, а ошибки оборачиваются в понятные уведомления как на клиенте, так и на сервере. Это соответствует ожиданиям аудита по прозрачности ошибок.
    -   **Асинхронные операции:** Генерация музыки инициируется с фронтенда и отслеживается через периодический опрос статуса трека, что предотвращает блокировку интерфейса и отражает описанную в документации схему взаимодействия.

-   **Качество кода:**
    -   Компоненты UI и бизнес-логика разделены: пользовательские хуки отвечают за работу с API, а компоненты — за отображение и UX. Такой подход упрощает модульное тестирование и развитие системы.

## Заключение

Архитектура приложения поддерживает чёткое разделение обязанностей между клиентской и серверной частями: фронтенд обеспечивает пользовательский опыт, а бэкенд управляет данными, бизнес-логикой и интеграциями. Это упрощает независимую разработку каждого слоя и снижает риски безопасности, поскольку доступ к базе данных и конфиденциальные операции сосредоточены на сервере.