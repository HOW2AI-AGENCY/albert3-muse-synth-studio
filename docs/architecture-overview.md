# Обзор архитектуры приложения

Этот документ предоставляет детальный обзор архитектуры приложения, описывая ключевые компоненты и их взаимодействие.

## Общая философия

Приложение разработано с четким разделением между фронтендом и бэкендом, что обеспечивает модульность, масштабируемость и безопасность.

- **Фронтенд:** Отвечает за пользовательский интерфейс и взаимодействие с пользователем.
- **Бэкенд:** Управляет данными, бизнес-логикой и взаимодействием со сторонними сервисами.

## Технологический стек

- **Фронтенд:**
  - **React:** Библиотека для создания пользовательских интерфейсов.
  - **Vite:** Инструмент для сборки и разработки.
  - **TypeScript:** Типизированный язык программирования, повышающий надежность кода.
  - **Tailwind CSS:** CSS-фреймворк для быстрой стилизации.
  - **React Router:** Для навигации по приложению.
  - **React Query:** Для управления состоянием сервера и кэширования данных.

- **Бэкенд:**
  - **Supabase:** Платформа "Backend-as-a-Service" (BaaS), предоставляющая:
    - **PostgreSQL:** Реляционная база данных.
    - **Аутентификация:** Управление пользователями и доступом.
    - **Edge Functions:** Бессерверные функции на Deno для выполнения серверной логики.
    - **Хранилище:** Для хранения файлов, таких как аудио.

## Структура проекта

### Фронтенд (`src/`)

Фронтенд представляет собой самодостаточное React-приложение со следующей структурой:

- `main.tsx`: Точка входа, где инициализируется приложение.
- `App.tsx`: Корневой компонент, настраивающий маршрутизацию, провайдеры контекста и глобальные компоненты.
- `pages/`: Компоненты, соответствующие отдельным страницам (например, `Landing`, `Auth`, `Workspace`).
- `components/`: Переиспользуемые UI-компоненты (`кнопки`, `диалоги`, `формы`).
- `contexts/`: Провайдеры контекста для управления глобальным состоянием (например, `AudioPlayerContext`).
- `hooks/`: Пользовательские хуки для инкапсуляции логики.
- `services/`: Функции для взаимодействия с API бэкенда (Supabase).
- `utils/`: Вспомогательные утилиты.

### Бэкенд (`supabase/`)

Бэкенд построен на Supabase и имеет стандартную структуру:

- `migrations/`: SQL-миграции для управления схемой базы данных.
- `functions/`: Бессерверные Edge Functions, написанные на Deno/TypeScript. Каждая функция выполняет определенную задачу (например, `generate-music`, `get-balance`).
  - `_shared/`: Общий код, используемый несколькими функциями.
- `config.toml`: Конфигурационный файл Supabase.

## Взаимодействие фронтенда и бэкенда

Взаимодействие между фронтендом и бэкендом происходит исключительно через API:

1.  **Аутентификация:** Фронтенд использует клиентскую библиотеку Supabase (`@supabase/supabase-js`) для регистрации, входа и управления сессиями пользователей. Защищенные маршруты на фронтенде проверяют наличие действительного токена JWT.
2.  **Запросы данных:** Фронтенд запрашивает данные из базы данных PostgreSQL через API Supabase, соблюдая правила безопасности на уровне строк (Row Level Security, RLS).
3.  **Вызов бизнес-логики:** Для выполнения сложных или привилегированных операций (например, генерация музыки, обработка платежей) фронтенд вызывает соответствующие Edge Functions через их HTTPS-эндпоинты.

## Результаты аудита

Проведенный углубленный аудит кода подтверждает, что теоретическая архитектура, описанная выше, успешно реализована на практике.

-   **Безопасность:**
    -   **Клиентская часть:** Фронтен-приложение корректно использует публичный ключ Supabase (`anon key`), не раскрывая никаких секретных токенов. Доступ к данным строго контролируется через политики RLS.
    -   **Серверная часть:** Бэкенд-функции надежно защищены. Они требуют авторизации пользователя, проверяют права владения данными и используют `service_role` ключ исключительно в серверной среде. Присутствует механизм ограничения частоты запросов (rate limiting) для защиты от злоупотреблений.

-   **Надежность:**
    -   **Обработка ошибок:** В приложении реализована централизованная и многоуровневая система обработки ошибок как на фронтенде (`ApiService`), так и на бэкенде, что обеспечивает стабильность работы.
    -   **Асинхронные операции:** Сложные задачи, такие как генерация музыки, выполняются асинхронно с использованием фоновых процессов (polling), что предотвращает блокировку интерфейса и обеспечивает хороший пользовательский опыт.
    -   **Идемпотентность:** Ключевые операции, создающие ресурсы, являются идемпотентными, что защищает систему от случайного создания дубликатов.

-   **Качество кода:**
    -   Код хорошо структурирован, следует принципу разделения ответственности и использует модульный подход.
    -   Применяется исчерпывающее логирование, что значительно упрощает отладку и мониторинг системы.

## Заключение

Архитектура приложения четко разделяет обязанности между клиентской и серверной частями. Фронтенд сфокусирован на отображении, а бэкенд — на логике и данных. Это обеспечивает безопасность, так как конфиденциальные операции и прямой доступ к базе данных инкапсулированы на сервере, и упрощает независимую разработку и масштабирование каждой части системы.