# üéµ Track Versioning System

**Version:** 2.0.0
**Date:** 2025-11-10
**Status:** ‚úÖ Refactored & Stable

---

## üìã Table of Contents

1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Database Schema](#database-schema)
4. [API Layer](#api-layer)
5. [React Hooks](#react-hooks)
6. [Migration Guide](#migration-guide)
7. [Best Practices](#best-practices)
8. [Troubleshooting](#troubleshooting)

---

## Overview

The Track Versioning System manages **track variants** - alternative versions of a music track generated by AI providers (Suno, Mureka). This system was refactored in **v2.0.0** to eliminate confusion around "version 0" and provide a cleaner API.

### Key Concepts

| Concept | Description | Location |
|---------|-------------|----------|
| **Main Track** | The original/primary track | `tracks` table |
| **Variant** | An alternative version | `track_versions` table |
| **Variant Index** | Numbering for variants (1, 2, 3...) | `track_versions.variant_index` |
| **Preferred Variant** | User-selected "master" variant | `track_versions.is_preferred_variant` |

### Architecture Principles

‚úÖ **DO**:
- Store main track in `tracks` table
- Store variants in `track_versions` with `variant_index >= 1`
- Use `is_preferred_variant` to mark the user's favorite

‚ùå **DON'T**:
- Create `variant_index = 0` (constraint prevents this)
- Duplicate main track in `track_versions`
- Use `is_primary_variant` (removed in v2.0.0)

---

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TRACKS TABLE                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  Main Track (Original)                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - id: uuid                                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - title, audio_url, cover_url                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - status, lyrics, duration                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Created by user via /generate-suno           ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚îÇ parent_track_id
                        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              TRACK_VERSIONS TABLE                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Variant 1 (variant_index: 1)                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - is_preferred_variant: false                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - audio_url, cover_url, duration                ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Variant 2 (variant_index: 2) ‚≠ê PREFERRED       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - is_preferred_variant: true                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - audio_url, cover_url, duration                ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Variant 3 (variant_index: 3)                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - is_preferred_variant: false                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - audio_url, cover_url, duration                ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Data Flow

```
User generates track
      ‚Üì
Edge Function (generate-suno)
      ‚Üì
AI Provider returns 2 clips
      ‚Üì
Webhook saves results
      ‚Üì
  tracks table:
    - First clip ‚Üí Main track
  track_versions table:
    - Second clip ‚Üí Variant 1 (variant_index: 1)
```

---

## Database Schema

### `tracks` Table

```sql
CREATE TABLE tracks (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  title TEXT NOT NULL,
  audio_url TEXT,
  cover_url TEXT,
  video_url TEXT,
  duration INTEGER,
  duration_seconds INTEGER,
  lyrics TEXT,
  status TEXT NOT NULL DEFAULT 'pending',
  provider TEXT DEFAULT 'suno',
  suno_id TEXT,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Purpose**: Stores the primary/original track.

### `track_versions` Table

```sql
CREATE TABLE track_versions (
  id UUID PRIMARY KEY,
  parent_track_id UUID NOT NULL REFERENCES tracks(id) ON DELETE CASCADE,
  variant_index INTEGER NOT NULL, -- ‚úÖ MUST BE >= 1
  is_preferred_variant BOOLEAN DEFAULT false,
  audio_url TEXT,
  cover_url TEXT,
  video_url TEXT,
  duration INTEGER,
  lyrics TEXT,
  suno_id TEXT,
  like_count INTEGER DEFAULT 0, -- Auto-updated by trigger
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- Constraints
  UNIQUE(parent_track_id, variant_index),
  CHECK (variant_index >= 1) -- ‚úÖ ENFORCED: No version 0
);
```

**Purpose**: Stores alternative versions of tracks.

**Indexes**:
```sql
CREATE INDEX idx_track_versions_parent ON track_versions(parent_track_id);
CREATE INDEX idx_track_versions_preferred ON track_versions(is_preferred_variant);
CREATE INDEX idx_track_versions_variant_index ON track_versions(variant_index);
```

### Triggers

#### `update_version_likes_count`

```sql
-- Auto-updates like_count when likes are added/removed
CREATE TRIGGER update_version_likes_count
  AFTER INSERT OR DELETE ON track_version_likes
  FOR EACH ROW
  EXECUTE FUNCTION update_track_version_like_count();
```

### RPC Functions

#### `set_master_version(parent_track_id, version_id)`

```sql
-- Atomically sets the preferred variant
SELECT * FROM set_master_version(
  'parent-track-uuid',
  'variant-uuid'
);
```

---

## API Layer

### Types (`src/features/tracks/api/trackVersions.ts`)

#### `TrackVariant`

```typescript
interface TrackVariant {
  id: string;
  parentTrackId: string;
  variantIndex: number; // 1, 2, 3...
  isPreferredVariant: boolean;
  likeCount?: number;
  audioUrl?: string;
  coverUrl?: string;
  duration?: number;
  lyrics?: string;
  sunoId?: string;
  metadata?: TrackMetadata | null;
  createdAt?: string;
}
```

#### `TrackWithVariantsResult`

```typescript
interface TrackWithVariantsResult {
  mainTrack: {
    id: string;
    title: string;
    audioUrl?: string;
    coverUrl?: string;
    duration?: number;
    lyrics?: string;
    styleTags?: string[];
    status?: string;
    userId?: string;
    sunoId?: string;
    metadata?: TrackMetadata | null;
    createdAt?: string;
  };
  variants: TrackVariant[];
  preferredVariant: TrackVariant | null;
}
```

### Functions

#### `getTrackWithVariants(trackId: string)`

```typescript
// ‚úÖ NEW API (v2.0.0)
const result = await getTrackWithVariants(trackId);

if (result) {
  console.log('Main track:', result.mainTrack.title);
  console.log('Variants:', result.variants.length);
  console.log('Preferred:', result.preferredVariant?.variantIndex);
}
```

**Returns**:
- `mainTrack`: The original track from `tracks` table
- `variants`: Array of variants (variant_index >= 1)
- `preferredVariant`: The variant marked as preferred, or null

#### `getTrackWithVersions(trackId: string)` ‚ö†Ô∏è DEPRECATED

```typescript
// ‚ùå DEPRECATED (legacy API)
// Use getTrackWithVariants() instead
const versions = await getTrackWithVersions(trackId);
```

---

## React Hooks

### `useTrackVariants()` ‚úÖ NEW

```typescript
import { useTrackVariants } from '@/features/tracks';

function TrackComponent({ trackId }: { trackId: string }) {
  const {
    mainTrack,
    variants,
    preferredVariant,
    variantCount,
    isLoading,
    reload,
    setPreferred,
    hasVariants,
  } = useTrackVariants(trackId);

  if (isLoading) return <div>Loading...</div>;

  return (
    <div>
      <h2>{mainTrack?.title}</h2>
      <p>{variantCount} variants available</p>

      {variants.map(variant => (
        <div key={variant.id}>
          <span>Variant {variant.variantIndex}</span>
          {variant.isPreferredVariant && <span>‚≠ê Preferred</span>}
          <button onClick={() => setPreferred(variant.id)}>
            Set as preferred
          </button>
        </div>
      ))}
    </div>
  );
}
```

**API**:
```typescript
interface UseTrackVariantsReturn {
  mainTrack: MainTrack | null;
  variants: TrackVariant[];
  preferredVariant: TrackVariant | null;
  variantCount: number;
  isLoading: boolean;
  error: Error | null;
  reload: (options?: { force?: boolean }) => Promise<void>;
  setPreferred: (variantId: string) => Promise<void>;
  hasVariants: boolean;
}
```

### `useTrackVariantCount()` ‚úÖ NEW

```typescript
// Lightweight hook for count only
const variantCount = useTrackVariantCount(trackId);
```

### `useTrackVersions()` ‚ö†Ô∏è DEPRECATED

```typescript
// ‚ùå DEPRECATED: Use useTrackVariants() instead
const { versions, allVersions } = useTrackVersions(trackId);
```

---

## Migration Guide

### From v1.x to v2.0.0

#### 1. Database Migration

Run migrations in order:
```bash
# Apply migrations (auto-applied by Supabase)
supabase/migrations/20251110130623_add_variant_index_constraint.sql
supabase/migrations/20251110130624_remove_is_primary_variant.sql
supabase/migrations/20251110130625_add_version_likes_trigger.sql
```

These migrations will:
- ‚úÖ Delete any `variant_index = 0` entries
- ‚úÖ Add `CHECK (variant_index >= 1)` constraint
- ‚úÖ Remove unused `is_primary_variant` column
- ‚úÖ Add trigger for `like_count` updates

#### 2. Code Migration

**Update imports**:
```typescript
// Before
import { useTrackVersions } from '@/features/tracks';
const { allVersions, masterVersion } = useTrackVersions(trackId);

// After
import { useTrackVariants } from '@/features/tracks';
const { mainTrack, variants, preferredVariant } = useTrackVariants(trackId);
```

**Update logic**:
```typescript
// Before: Checking for version 0
const mainVersion = allVersions.find(v => v.sourceVersionNumber === 0);

// After: Main track is separate
const { mainTrack } = useTrackVariants(trackId);
```

**Update variant display**:
```typescript
// Before: Confusing numbering
<span>Version {version.versionNumber}</span> // Could be 1, 2, 3...

// After: Clear numbering
<span>Variant {variant.variantIndex}</span> // Always 1, 2, 3...
```

---

## Best Practices

### ‚úÖ DO

1. **Use the new API**:
   ```typescript
   const { mainTrack, variants } = useTrackVariants(trackId);
   ```

2. **Display main track separately**:
   ```tsx
   <div className="main-track">
     <h3>{mainTrack.title}</h3>
     <span>Original</span>
   </div>

   <div className="variants">
     {variants.map(v => (
       <div key={v.id}>Variant {v.variantIndex}</div>
     ))}
   </div>
   ```

3. **Set preferred variant**:
   ```typescript
   await setPreferred(variantId);
   ```

### ‚ùå DON'T

1. **Don't create variant_index = 0**:
   ```typescript
   // ‚ùå This will fail due to CHECK constraint
   await supabase.from('track_versions').insert({
     parent_track_id: trackId,
     variant_index: 0, // ERROR!
   });
   ```

2. **Don't mix main track with variants**:
   ```typescript
   // ‚ùå Wrong: Treating main track as variant
   const allTracks = [mainTrack, ...variants];

   // ‚úÖ Correct: Keep them separate
   <div>
     <MainTrackCard track={mainTrack} />
     <VariantsList variants={variants} />
   </div>
   ```

3. **Don't use deprecated APIs**:
   ```typescript
   // ‚ùå Deprecated
   const { allVersions } = useTrackVersions(trackId);

   // ‚úÖ Use new API
   const { mainTrack, variants } = useTrackVariants(trackId);
   ```

---

## Troubleshooting

### Issue: "variant_index must be >= 1" error

**Cause**: Trying to create a variant with `variant_index = 0`

**Solution**: Store the main track in `tracks` table, not `track_versions`:
```typescript
// ‚úÖ Correct
await supabase.from('tracks').insert({
  title: 'My Track',
  audio_url: mainAudioUrl,
});

await supabase.from('track_versions').insert({
  parent_track_id: trackId,
  variant_index: 1, // Start from 1
  audio_url: variantAudioUrl,
});
```

### Issue: Variants not showing in UI

**Check**:
1. Database: `SELECT * FROM track_versions WHERE parent_track_id = '...'`
2. API: `const result = await getTrackWithVariants(trackId)`
3. Cache: `invalidateTrackVariantsCache(trackId)`

### Issue: Preferred variant not updating

**Solution**: Use `setMasterVersion()` RPC:
```typescript
import { setMasterVersion, unwrapResult } from '@/features/tracks/api/trackVersions';

const result = await setMasterVersion(parentTrackId, variantId);
unwrapResult(result); // Throws if error
```

---

## See Also

- [DATABASE_SCHEMA.md](./DATABASE_SCHEMA.md) - Complete database schema
- [ARCHITECTURE.md](./ARCHITECTURE.md) - System architecture overview
- [CLAUDE.md](../CLAUDE.md) - Development guidelines

---

**Version History**:
- v2.0.0 (2025-11-10): Major refactor - removed version 0, new API
- v1.x (2025-10-15): Initial implementation with version_number/is_master
