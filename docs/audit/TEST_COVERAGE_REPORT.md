# Отчет о состоянии и покрытии тестов

**Дата:** 27 ноября 2025 г.
**Инструмент:** `vitest run --coverage`

## 1. Executive Summary

Анализ тестового набора выявил критическую проблему: **значительная часть существующих тестов (103 из 441, или ~23%) находится в падающем состоянии (`failed`)**. Это свидетельствует о рассинхронизации тестов с кодовой базой и делает их бесполезными в качестве инструмента проверки качества.

Приоритетной задачей является не наращивание покрытия, а **ремонт и стабилизация существующего тестового набора**. Пока тесты не станут "зелеными", доверять им нельзя, и любые новые тесты рискуют быстро устареть.

Из-за большого количества ошибок в выводе команды `vitest` отсутствует итоговая таблица с процентами покрытия по файлам. Это делает невозможным точную оценку покрытия на данный момент, но подчеркивает серьезность проблемы с падающими тестами.

## 2. Статистика выполнения тестов

| Метрика | Всего | ✅ Прошли | ❌ Упали | ⏩ Пропущены |
| :--- | :--- | :--- | :--- | :--- |
| **Тестовые файлы** | 52 | 27 | **24** | 1 |
| **Индивидуальные тесты** | 441 | 326 | **103** | 12 |

## 3. Анализ причин падения тестов

Основная причина падений — `TestingLibraryElementError`. Это говорит о том, что тесты стали "хрупкими" (`brittle`) из-за изменений в UI-компонентах.

- **Ненадежные селекторы:** Тесты ищут элементы по тексту, ролям или классам, которые изменились (`Found multiple elements`, `Unable to find an element`).
- **Изменение UI/UX:** Ожидаемый результат (например, текст "4 words" или CSS-класс `"compact"`) больше не соответствует действительности.

**Примеры проблемных тест-сьютов:**
- `tests/unit/utils/performanceMonitor.test.ts` (11 из 11 тестов упали)
- `src/components/lyrics/__tests__/LyricsWorkspace.test.tsx` (множественные падения)
- `tests/unit/components/ProjectCard.test.tsx` (падения связаны с UI)

## 4. Карта покрытия (приблизительная)

Несмотря на отсутствие точных цифр, по списку запущенных файлов можно составить приблизительную карту областей, где тесты *существуют* (хотя и падают).

- **Хорошее покрытие (много тестов):**
    - Хуки (`src/hooks/__tests__/`)
    - Утилиты (`src/utils/__tests__/`, `tests/unit/utils/`)
    - UI-компоненты (`src/components/.../__tests__/`)
- **Недостаточное или отсутствующее покрытие (требует проверки):**
    - Сервисный слой (`src/services/`)
    - Стейт-менеджмент (`src/stores/`)
    - Страницы (`src/pages/`)
    - Edge-функции (`supabase/functions/`)

## 5. План действий и рекомендации

1.  **[P0] Стабилизировать тестовый набор:**
    - **Задача:** Создать эпик "Ремонт падающих Unit-тестов".
    - **Подзадачи:** Для каждого из 24 падающих файлов создать отдельную задачу на исправление. Начать с самых простых (где падает 1-2 теста).
    - **Критерий приемки:** Команда `npx vitest run` завершается с 0 `failed` тестов.

2.  **[P1] Улучшить надежность селекторов:**
    - **Задача:** Провести ревью E2E и Unit-тестов на предмет использования надежных селекторов.
    - **Рекомендация:** Внедрить практику использования `data-testid` для всех интерактивных элементов, чтобы отвязать тесты от хрупких CSS-классов и текстового контента.

3.  **[P2] Наращивать покрытие после стабилизации:**
    - **Задача:** После того как все тесты станут "зелеными", сгенерировать актуальный отчет о покрытии.
    - **Подзадачи:** Создать задачи на написание тестов для критичных модулей с покрытием < 50%, начиная с сервисного слоя и стейт-менеджмента.

**Заключение:** Технический долг в тестах достиг критической отметки. Игнорирование этой проблемы приведет к полной потере доверия к автоматизированному тестированию и увеличению количества регрессионных ошибок.
