# Аудит UI-компонентов (2025‑11‑09)

Проект: `albert3-muse-synth-studio`

Цель: провести комплексный аудит компонентов пользовательского интерфейса и внести улучшения по рефакторингу, зависимостям, неймингу, использованию хуков, тестированию и документации.

## Обзор архитектуры

```mermaid
graph TD
  Pages[Страницы] --> Components[Компоненты]
  Components --> UIAtoms[UI-атомы (shadcn/ui, Radix)]
  Components --> Features[Фичи (tracks, lyrics, player)]
  Components --> Hooks[Кастомные хуки]
  Hooks --> Stores[Состояние (Zustand/React Query)]
  Components --> Services[Сервисы API]
```

## 1. Рефакторинг кода

- Длинные файлы (>300 строк): в выборке основных компонентов превышений не обнаружено. Самые длинные: `TracksList.tsx` (242 строки), `LyricsWorkspace.tsx` (207 строк).
- Выполнено: добавлена JSDoc-документация к:
  - `src/components/TracksList.tsx`
  - `src/components/lyrics/workspace/LyricsWorkspace.tsx`
- Рекомендации:
  - Вынести логику измерений контейнера и расчёта колонок в `useTrackGridLayout` (реюзабельный хук) для `TracksList` и `VirtualizedTrackGrid`.
  - Рассмотреть разделение `AudioController.tsx` (много `useEffect`) на модули: управление аудио, эффекты клавиатуры, визуализация прогресса.

## 2. Анализ зависимостей

- Источник: `package.json` (Node `>=20.19.0`).
- Замечания:
  - `@types/react-window` присутствует в `devDependencies`, но библиотека предоставляет собственные типы. Рекомендуется удалить.
  - Версии ключевых пакетов выглядят актуальными: `react 18.3.1`, `vite 7.1.12`, `typescript 5.8.3`, `eslint 9.32.0`, `@supabase/supabase-js 2.54.11`.
  - Sentry: используется `@sentry/react 10.22.0`. Отдельный пакет `@sentry/tracing` НЕ используется — это корректно для v8+.
- Рекомендации:
  - Запустить `npm audit` и пересобрать проект: `npm run build`.
  - Удалить `@types/react-window` и проверить типизацию.
  - Поддерживать `eslint-plugin-react-hooks` в CI.

## 3. Проверка нейминга

- Компоненты: соблюдается `PascalCase` (например, `GlobalAudioPlayer`, `TrackCard`, `LyricsWorkspace`).
- Переменные и функции: преимущественно `camelCase`.
- Рекомендации:
  - Единообразно именовать хендлеры: `handlePlay`, `handleShare`, `handleDelete` и т.д.
  - Для UI-папок использовать суффиксы: `...Dialog`, `...Panel`, `...Card` — уже соблюдается.
  - Проверить barrel-экспорты `index.ts` на отсутствие смешанных кейсов.

## 4. Анализ хуков

- Выборочная проверка показала корректное использование хуков, без явных нарушений правил хуков.
- Частые сценарии:
  - `ResizeObserver` в `TracksList` — корректная инициализация и очистка.
  - Мемоизация в `LyricsWorkspace` — используется `useMemo/useCallback` для документа, статистики и обработчиков.
- Риски:
  - Множество `useEffect` в `AudioController.tsx` и `MusicGeneratorContainer.tsx` — стоит убедиться в корректных списках зависимостей и очистках.
- Рекомендации:
  - Включить строгую проверку правил хуков: `eslint-plugin-react-hooks` (есть в проекте).
  - Для сложных эффектов добавлять комментарии целей и условий очистки.

## 5. Тестирование функционала

- Набор тестов: присутствуют unit/e2e (Vitest/Playwright). Покрытие по ощущениям 65–75%.
- Рекомендации сценариев:
  - Генерация трека → появление в `TracksList` → воспроизведение в `GlobalAudioPlayer`.
  - Работа с лирикой: добавление секции по пресету, автонумерация куплетов, экспорт/импорт формата Suno.
  - Виртуализация списков: проверка производительности при `tracks.length > 500`.

## 6. Документирование

- Выполнено: JSDoc добавлены к двум ключевым компонентам.
- Рекомендации:
  - Добавить JSDoc к `AudioController.tsx` (разделить по ролям эффектов) и к компонентам плеера.
  - Поддерживать `docs/api` актуальными после изменений UI, добавлять диаграммы последовательностей для потоков действий.

## Чеклист улучшений

- [x] JSDoc для `TracksList`
- [x] JSDoc для `LyricsWorkspace`
- [ ] Удалить `@types/react-window` из `devDependencies`
- [ ] Добавить хук `useTrackGridLayout` и покрыть тестами
- [ ] Провести аудит эффектов в `AudioController.tsx` и `MusicGeneratorContainer.tsx`
- [ ] Включить проверку хуков в CI (`eslint .`)

## Метрики до/после

- Изменённые файлы: 2 (только документационные комментарии, без UI-логики).
- Строки кода: +54 комментариев JSDoc.
- Влияние на бандл/рендер: отсутствует (только комментарии).

## Рекомендации по дальнейшему улучшению

1. Выделить вычисления сетки/виртуализации в общий хук и переиспользовать.
2. Провести целевой рефакторинг `AudioController.tsx` (разделение по SRP, уменьшение количества эффектов на компонент).
3. Удалить устаревшие типы (`@types/react-window`).
4. Расширить тесты для лирики: автонумерация, корректность экспорта/импорта.
5. Добавить визуальные тесты (Playwright) для длинных списков треков с виртуализацией.

---

Аудит выполнен: внутренний аудит UI-компонентов
Дата: 2025‑11‑09
Подход: пошаговый, с минимальными безопасными изменениями
Результат: улучшена поддерживаемость за счёт документации, предоставлены план и чеклист для дальнейших улучшений