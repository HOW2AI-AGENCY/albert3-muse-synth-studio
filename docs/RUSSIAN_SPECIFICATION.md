# Спецификация Проекта: Albert3 Muse Synth Studio

**Версия:** 1.0.0
**Дата:** 19 ноября 2025 г.
**Статус:** Проект

---

## 1. Введение

### 1.1. Цель документа

Этот документ представляет собой полную техническую и функциональную спецификацию для веб-приложения **Albert3 Muse Synth Studio**. Его цель — служить единым источником правды для команды разработки, менеджеров проекта и других заинтересованных сторон.

### 1.2. Целевая аудитория

-   **Разработчики:** Для понимания архитектуры, потоков данных, и требований к реализации.
-   **Тестировщики:** Для создания тест-кейсов и понимания ожидаемого поведения системы.
-   **Менеджеры:** Для обзора функциональности и планирования дальнейшего развития.

### 1.3. Обзор проекта

**Albert3 Muse Synth Studio** — это профессиональная SPA-платформа для AI-генерации музыки. Она предоставляет музыкантам и продюсерам инструментарий для создания, редактирования и управления треками с использованием передовых AI-технологий, таких как Suno (генерация) и Replicate (анализ).

---

## 2. Архитектура Системы

### 2.1. Общая архитектурная схема

Приложение построено по архитектуре **Frontend -> Backend-as-a-Service (BaaS)**. Фронтенд является полностью независимым SPA, которое взаимодействует с бэкендом через API.

![Архитектурная схема](https://github.com/HOW2AI-AGENCY/albert3-muse-synth-studio/blob/4e0a04e28c78d2e45e6c6ca47d266e7a3521629c/docs/assets/ARCHITECTURAL_OVERVIEW.jpg)

### 2.2. Технологический стек

| Слой | Технология | Назначение |
| :--- | :--- | :--- |
| **Frontend** | React, TypeScript, Vite | UI, типизация и сборка |
| **UI** | Tailwind CSS, shadcn/ui | Стилизация и UI-компоненты |
| **Состояние** | TanStack Query, Zustand | Управление серверным и клиентским состоянием |
| **Бэкенд** | Supabase | BaaS (база данных, аутентификация, хранилище) |
| **Edge Functions**| Deno, TypeScript | Серверная логика и интеграции |
| **База данных**| PostgreSQL | Хранение данных |
| **AI-сервисы** | Suno, Replicate | Генерация и анализ аудио |
| **Мониторинг**| Sentry | Отслеживание ошибок и производительности |

### 2.3. Архитектура Фронтенда

Исходный код находится в `src/` и имеет модульную, feature-sliced структуру.

-   `pages/`: Компоненты-страницы, соответствующие роутам.
-   `components/`: Переиспользуемые UI-компоненты (атомы, молекулы).
-   `features/`: Изолированные модули, содержащие бизнес-логику и UI для конкретной функции (например, `features/tracks`).
-   `hooks/`: Кастомные хуки, инкапсулирующие сложную логику.
-   `services/`: Модули для инкапсуляции вызовов API к Edge-функциям.
-   `stores/`: Глобальные хранилища состояния на Zustand (например, `audioPlayerStore`).
-   `contexts/`: Провайдеры React Context (Auth, Subscription).

### 2.4. Архитектура Бэкенда

Серверная логика реализована в виде **Supabase Edge Functions** на Deno.

-   **Структура:** Каждая функция находится в своей директории (например, `supabase/functions/generate-suno/`) и имеет точку входа `index.ts`.
-   **Общий код:** Директория `_shared/` содержит переиспользуемый код для CORS, аутентификации, клиентов Supabase, валидации Zod и т.д.
-   **Паттерны:**
    -   **Валидация:** Zod-схемы для всех входящих запросов.
    -   **Безопасность:** Проверка JWT-токена пользователя, RLS в базе данных.
    -   **Отказоустойчивость:** Rate limiting, обработка ошибок, логирование.

### 2.5. Архитектура Базы Данных

Используется PostgreSQL, управляемый Supabase. Схема определяется через миграционные файлы в `supabase/migrations/`.

-   **Ключевые таблицы:**
    -   `profiles`: Данные пользователей.
    -   `tracks`: Основная информация о треках.
    -   `track_versions`: Конкретные AI-сгенерированные версии трека.
    -   `subscription_plans`, `generation_limits`: Данные для системы подписок.
    -   `track_version_likes`: Социальная функция "лайков".
    -   `prompt_dj_presets`: Пользовательские пресеты.
-   **Особенности:**
    -   **RLS (Row-Level Security):** Активно используется для защиты данных пользователей.
    -   **Триггеры и функции:** Автоматизация задач, таких как обновление кешированных счетчиков (`like_count`).
    -   **CRON Jobs:** `pg_cron` используется для периодических задач (сброс лимитов).

---

## 3. Ключевые Функции

### 3.1. Аутентификация и Управление Пользователями

-   **Регистрация и вход:** Через email/пароль.
-   **Сессии:** Управляются через Supabase Auth (JWT).
-   **Профили:** Пользователи имеют профили в таблице `profiles`.

### 3.2. Генерация Музыки (Suno)

Это асинхронный процесс.

1.  **Инициация (Frontend):** Пользователь заполняет форму (промпт, стиль и т.д.) и отправляет запрос. `GenerationService` вызывает Edge-функцию `generate-suno`.
2.  **Обработка (Backend):**
    -   `generate-suno` валидирует запрос, проверяет лимиты пользователя.
    -   Отправляет запрос в Suno API, указывая `suno-callback` как вебхук.
    -   Создает запись о задаче в `ai_jobs` для идемпотентности.
3.  **Завершение (Backend):**
    -   Suno API по завершении генерации вызывает вебхук `suno-callback`.
    -   `suno-callback` получает данные о сгенерированных треках, скачивает их в Supabase Storage и создает записи в `track_versions`.
4.  **Оповещение (Frontend):** Frontend слушает изменения в таблице `track_versions` через Supabase Realtime и обновляет UI, когда трек готов.

### 3.3. Анализ Аудио (Replicate)

-   **Функционал:** Анализ BPM, тональности, жанра и других характеристик аудио.
-   **Процесс:** Аналогичен генерации, использует Edge-функцию `analyze-audio` и вебхук `replicate-callback`.

### 3.4. Система Версионирования Треков

-   Каждый трек (`tracks`) может иметь несколько версий (`track_versions`).
-   Пользователь может переключаться между версиями в UI.
-   Одна из версий может быть помечена как "мастер-версия".
-   Функции, такие как "лайки", привязаны к конкретной версии.

### 3.5. Система Подписок и Лимитов

-   **Тарифы:** Существуют разные планы подписки (`subscription_plans`).
-   **Лимиты:** Каждый тариф имеет свои лимиты на генерацию (`generation_limits`).
-   **Проверка:** Edge-функции проверяют лимиты пользователя перед выполнением ресурсоемких операций.
-   **Сброс:** `pg_cron` ежедневно сбрасывает дневные лимиты.

### 3.6. DAW / Аудио-редактор

-   **Функционал:** Базовый интерфейс для редактирования аудио дорожек в стиле Digital Audio Workstation.
-   **Компоненты:** Timeline, waveform display, spectrum analyzer.
-   **Состояние:** Управляется через Zustand-стор (`dawStore`).
-   **Сохранение:** Проекты DAW сохраняются в базу данных.

### 3.7. Prompt DJ

-   **Функционал:** Продвинутый инструмент для генерации музыки с возможностью сохранения и повторного использования наборов промптов.
-   **БД:** Пользовательские наборы сохраняются в таблице `prompt_dj_presets`.

---

## 4. Пользовательский Интерфейс и UX

### 4.1. Основные экраны

-   `/auth`: Страница входа и регистрации.
-   `/workspace/library`: Библиотека треков пользователя.
-   `/workspace/generate`: Основной интерфейс для генерации музыки.
-   `/workspace/daw/:id`: Аудио-редактор.
-   `/workspace/prompt-dj`: Интерфейс "Prompt DJ".

### 4.2. Ключевые компоненты

-   `GlobalAudioPlayer`: Глобальный плеер, который отображается внизу экрана.
-   `TrackCard`: Карточка трека с основной информацией и действиями.
-   `MusicGenerator`: Основная форма для создания музыки.
-   `SelectionToolbar`: Панель, появляющаяся при выборе нескольких треков для массовых операций.

### 4.3. Принципы дизайна

-   **Тема:** Темная тема по умолчанию.
-   **Адаптивность:** Интерфейс полностью адаптивен для мобильных и десктопных устройств.
-   **Компонентная база:** Используется библиотека `shadcn/ui`, построенная поверх Tailwind CSS.

---

## 5. Интеграции со Сторонними Сервисами

### 5.1. Suno API

-   **Назначение:** Генерация музыки.
-   **Взаимодействие:** Через `SunoGenerationHandler` в Edge-функциях. Используется асинхронный паттерн с вебхуками.

### 5.2. Replicate.com API

-   **Назначение:** Анализ аудио.
-   **Взаимодействие:** Аналогично Suno, через Edge-функции.

### 5.3. Sentry

-   **Назначение:** Мониторинг ошибок и производительности.
-   **Интеграция:** Sentry SDK интегрирован как на фронтенде (`main.tsx`), так и в Edge-функциях для отслеживания исключений.

---

## 6. Рекомендации и Дальнейшее Развитие

### 6.1. Технический долг

-   **Низкое покрытие тестами:** Необходимо значительно увеличить количество unit-тестов для хуков, сервисов и компонентов.
-   **Документация:** Некоторые старые документы (например, `AGENT.md`) устарели и требуют обновления или удаления.
-   **Оптимизация сборки:** Есть предупреждения о размере чанков, что указывает на необходимость дальнейшей оптимизации (code-splitting).

### 6.2. Предложения по улучшению

-   **Рефакторинг `useTracks`:** Хук `useTracks` очень сложен. Его можно разбить на более мелкие и управляемые хуки.
-   **Улучшение UI/UX DAW:** Текущий DAW является базовым. Требуется расширение функционала (эффекты, микшер, MIDI).
-   **Тестирование Edge-функций:** Внедрить полноценное интеграционное тестирование для Edge-функций с использованием тестовой базы данных.

### 6.3. Дорожная карта (предварительная)

1.  **Q1:** Увеличение покрытия тестами до 50%. Рефакторинг ключевых хуков.
2.  **Q2:** Расширение функционала DAW (добавление real-time эффектов).
3.  **Q3:** Внедрение совместной работы над проектами.
4.  **Q4:** Интеграция с новыми AI-провайдерами.
