# üìú –°–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ (Prompt History System)

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π –ø—Ä–æ–º–ø—Ç–æ–≤ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏, —Å–≤—è–∑—å—é —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
- –ö–∞–∂–¥—ã–π –ø—Ä–æ–º–ø—Ç –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: —Ç–µ–∫—Å—Ç, —Ç–µ–≥–∏, –ø—Ä–æ–≤–∞–π–¥–µ—Ä, –º–æ–¥–µ–ª—å
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (pending/success/failed)
- –ò–∑–º–µ—Ä—è–µ—Ç—Å—è –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö

### üîç –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫
- **–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É**: Real-time –ø–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –ø—Ä–æ–º–ø—Ç–∞ (debounced 300ms)
- **–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ**: –°–µ–≥–æ–¥–Ω—è, –í—á–µ—Ä–∞, 7 –¥–Ω–µ–π, 30 –¥–Ω–µ–π, –í—Å—ë –≤—Ä–µ–º—è
- **–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É**: Suno, Mureka, –í—Å–µ
- **–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É**: –£—Å–ø–µ—à–Ω—ã–µ, –û—à–∏–±–∫–∏, –í –ø—Ä–æ—Ü–µ—Å—Å–µ, –í—Å–µ

### üìä –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º
- **–°–µ–≥–æ–¥–Ω—è**: –ü—Ä–æ–º–ø—Ç—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
- **–í—á–µ—Ä–∞**: –ü—Ä–æ–º–ø—Ç—ã –∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å
- **–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π**: –ü—Ä–æ–º–ø—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é (–∫—Ä–æ–º–µ —Å–µ–≥–æ–¥–Ω—è/–≤—á–µ—Ä–∞)
- **–†–∞–Ω–µ–µ**: –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã

### üîó –°–≤—è–∑—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
- –ö–∞–∂–¥—ã–π –ø—Ä–æ–º–ø—Ç —Å–≤—è–∑–∞–Ω —Å —Ç—Ä–µ–∫–æ–º, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–µ–≤—å—é —Ç—Ä–µ–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ (–ª–∞–π–∫–∏, –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è)
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–µ–∫—É –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏

### üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏
- **JSON**: –≠–∫—Å–ø–æ—Ä—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
- **CSV**: –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ Excel/Google Sheets

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–¢–∞–±–ª–∏—Ü–∞ `prompt_history`:**
```sql
- result_track_id: UUID (—Å–≤—è–∑—å —Å tracks)
- generation_status: TEXT (pending/success/failed)
- generation_time_ms: INTEGER (–≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
- model_version: TEXT (–º–æ–¥–µ–ª—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)
```

**View `prompt_statistics`:**
```sql
SELECT
  ph.id, ph.prompt, ph.generation_status, ph.generation_time_ms,
  t.title as track_title, t.play_count, t.like_count
FROM prompt_history ph
LEFT JOIN tracks t ON ph.result_track_id = t.id
WHERE ph.user_id = auth.uid()
```

### Frontend Hooks

**`usePromptHistory(filters?: PromptFilters)`**
```typescript
const {
  history,           // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–ø—Ç–æ–≤
  promptStats,       // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
  isLoading,         // –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
  savePrompt,        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
  linkPromptToTrack, // –°–≤—è–∑–∞—Ç—å –ø—Ä–æ–º–ø—Ç —Å —Ç—Ä–µ–∫–æ–º
  markPromptFailed,  // –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∫–∞–∫ failed
  exportHistory,     // –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON/CSV
} = usePromptHistory({ dateRange: 'last7days', provider: 'suno' });
```

**–¢–∏–ø—ã:**
```typescript
interface PromptFilters {
  dateRange?: 'all' | 'today' | 'yesterday' | 'last7days' | 'last30days';
  provider?: 'all' | 'suno' | 'mureka';
  status?: 'all' | 'success' | 'failed' | 'pending';
  searchQuery?: string;
}
```

### UI Components

1. **PromptHistoryDialog** - –ì–ª–∞–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
2. **PromptHistoryFilters** - –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫
3. **GroupedPromptHistory** - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º
4. **PromptHistoryItem** - –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞
```typescript
import { PromptHistoryDialog } from '@/components/generator/prompt-history';

<PromptHistoryDialog
  open={historyOpen}
  onOpenChange={setHistoryOpen}
  onSelect={(item) => {
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ
    setParams({
      prompt: item.prompt,
      tags: item.style_tags?.join(', '),
      // ...
    });
  }}
/>
```

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```typescript
import { usePromptHistory } from '@/hooks/usePromptHistory';

const { savePrompt, linkPromptToTrack } = usePromptHistory();

// 1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
const { data: savedPrompt } = await savePrompt.mutateAsync({
  prompt: params.prompt,
  lyrics: params.lyrics,
  style_tags: params.styleTags,
  provider: 'suno',
  model_version: 'V5',
  generation_status: 'pending',
});

// 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º—É–∑—ã–∫–∏
const track = await generateMusic(params);

// 3. –°–≤—è–∑–∞—Ç—å –ø—Ä–æ–º–ø—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
await linkPromptToTrack.mutateAsync({
  promptId: savedPrompt.id,
  trackId: track.id,
  generationTimeMs: Date.now() - startTime,
});
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```typescript
try {
  const track = await generateMusic(params);
  await linkPromptToTrack.mutateAsync({...});
} catch (error) {
  // –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∫–∞–∫ failed
  await markPromptFailed.mutateAsync(promptId);
}
```

### –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏
```typescript
const { exportHistory } = usePromptHistory();

// –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
await exportHistory('json');

// –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
await exportHistory('csv');
```

## Performance

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **Debounced search**: –ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 300ms
- **Lazy loading**: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
- **Query caching**: TanStack Query –∫–µ—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- **Indexed queries**: –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `generation_status`, `result_track_id`, `user_id`

### –ú–µ—Ç—Ä–∏–∫–∏
- –ü–æ–∏—Å–∫: <50ms (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: <100ms (–¥–æ 1000 –ø—Ä–æ–º–ø—Ç–æ–≤)
- –≠–∫—Å–ø–æ—Ä—Ç CSV: <500ms (–¥–æ 10000 –∑–∞–ø–∏—Å–µ–π)

## Best Practices

### 1. –í—Å–µ–≥–¥–∞ —Å–≤—è–∑—ã–≤–∞–π—Ç–µ –ø—Ä–æ–º–ø—Ç—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
await linkPromptToTrack.mutateAsync({ promptId, trackId, generationTimeMs });

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–æ–º–ø—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑ —Å–≤—è–∑–∏ —Å —Ç—Ä–µ–∫–æ–º
await savePrompt.mutateAsync({ prompt });
```

### 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ failed —Å—Ç–∞—Ç—É—Å—ã
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
try {
  const track = await generateMusic(params);
} catch (error) {
  await markPromptFailed.mutateAsync(promptId);
}
```

### 3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
const { history } = usePromptHistory({ dateRange: 'last7days' });

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
const { history } = usePromptHistory({ dateRange: 'all' });
```

## Troubleshooting

### –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–º–ø—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –∫–µ—à –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
queryClient.invalidateQueries({ queryKey: ['prompt-history'] });
```

### –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∏—Å–∫ —Ç–æ—Ä–º–æ–∑–∏—Ç –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø—Ä–æ–º–ø—Ç–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã:
```sql
CREATE INDEX idx_prompt_history_user_created 
  ON prompt_history(user_id, created_at DESC);
```
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ debounced search (300ms)

### –ù–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –£ –ø—Ä–æ–º–ø—Ç–æ–≤ –Ω–µ—Ç –ø—Ä–µ–≤—å—é —Ç—Ä–µ–∫–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `result_track_id` –∑–∞–ø–æ–ª–Ω–µ–Ω:
```typescript
await linkPromptToTrack.mutateAsync({ promptId, trackId, generationTimeMs });
```

## Roadmap

### –§–∞–∑–∞ 2 (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- [ ] **A/B Testing UI**: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
- [ ] **Prompt Templates**: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ª—É—á—à–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
- [ ] **Analytics Dashboard**: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –ø—Ä–æ–º–ø—Ç–æ–≤
- [ ] **Prompt Optimization**: AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤

### –§–∞–∑–∞ 3 (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- [ ] **Collaborative prompts**: –®–∞—Ä–∏–Ω–≥ –ø—Ä–æ–º–ø—Ç–æ–≤ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- [ ] **Prompt versioning**: –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–∞
- [ ] **Auto-tagging**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤

## –°—Å—ã–ª–∫–∏

- [Hooks Documentation](../API.md#hooks)
- [Database Schema](../DATABASE_SCHEMA.md)
- [TanStack Query Guide](https://tanstack.com/query/latest/docs/react/guides/queries)
