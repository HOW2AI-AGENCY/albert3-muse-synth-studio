# План тестирования (Test Plan)

**Версия документа:** 1.0.0
**Дата:** 27 ноября 2025 г.

## 1. Философия тестирования

Мы придерживаемся концепции "пирамиды тестирования", которая обеспечивает оптимальное соотношение скорости, стоимости и надежности тестов.

- **Unit-тесты (70%):** Составляют основу пирамиды. Они быстрые, дешевые и проверяют изолированные компоненты, хуки и функции.
- **Интеграционные тесты (20%):** Проверяют взаимодействие нескольких модулей (например, компонент + хук + мок API).
- **E2E-тесты (10%):** Проверяют полные пользовательские сценарии в реальном браузере. Они медленные и хрупкие, поэтому их количество должно быть ограничено только самыми критичными путями.

**Целевое покрытие кода:** 80%

## 2. Инструменты

| Тип теста | Инструмент | Расположение | Команда для запуска |
| :--- | :--- | :--- | :--- |
| **Unit / Интеграционные** | **Vitest** | `*.test.ts(x)` | `npm test` |
| **End-to-end (E2E)** | **Playwright** | `tests/e2e/` | `npm run test:e2e` |
| **Проверка типов** | **TypeScript** | `src/` | `npm run typecheck`|
| **Линтинг** | **ESLint** | `src/` | `npm run lint` |

## 3. Стратегия тестирования без авторизации (`TEST_MODE`)

Для обеспечения стабильности и безопасности CI/CD-процессов, мы **не используем реальные учетные данные** в автоматических тестах. Вместо этого применяется `TEST_MODE`.

### Как это работает?

1.  **Переменная окружения:** Режим включается установкой переменной окружения `VITE_TEST_MODE=true`.
2.  **Мок-провайдер:** Когда приложение запускается в `TEST_MODE`, оно использует специальный мок-провайдер аутентификации (`MockAuthContext`) вместо реального.
3.  **Программный вход:** В E2E-тестах мы используем кастомные команды Playwright, которые взаимодействуют с `MockAuthContext`, чтобы программно "залогинить" пользователя с нужными правами, минуя реальную форму входа.

### Как запустить тесты локально в `TEST_MODE`

1.  **Создайте файл `.env.test` в корне проекта.**
2.  **Добавьте в него следующую строку:**
    ```
    VITE_TEST_MODE=true
    ```
3.  **Запустите E2E-тесты:**
    ```bash
    npm run test:e2e
    ```
    Playwright автоматически подхватит `.env.test` и запустит браузер в нужном режиме.

**На CI-сервере эта переменная окружения устанавливается автоматически.**

## 4. Категории тестов

### Publicable Tests (Тесты без авторизации)

- **Что тестируют:** Все публичные страницы (`/`, `/auth`), рендеринг отдельных UI-компонентов в изолированном окружении (через Storybook или `render` из Testing Library), утилитарные функции, хуки, не требующие данных пользователя.
- **Примеры:**
    - Unit-тест для функции `formatDate()`.
    - Unit-тест для компонента `<Button />`.
    - E2E-тест, проверяющий, что на странице `/auth` есть поля для ввода email и пароля.

### Private Tests (Тесты с мок-авторизацией)

- **Что тестируют:** Все защищенные роуты в `/workspace`, операции CRUD (создание, чтение, обновление, удаление) для сущностей пользователя, логику, специфичную для ролей.
- **Примеры:**
    - E2E-тест, проверяющий создание нового трека на странице `/workspace/generate`.
    - Интеграционный тест для хука `useTracks()`, который проверяет корректную загрузку треков для "залогиненного" пользователя.
    - Unit-тест компонента, который показывает разный UI для ролей `USER` и `ADMIN`.

## 5. Visual Snapshot-тестирование

Для предотвращения визуальной регрессии, особенно на мобильных устройствах, мы используем Playwright для снятия скриншотов ключевых компонентов и страниц.

- **Где находятся:** `tests/e2e/visual.spec.ts`
- **Как работает:** При первом запуске теста Playwright делает эталонные скриншоты. При последующих запусках он сравнивает текущий рендер с эталоном. Если есть расхождения, тест падает.
- **Обновление скриншотов:**
    ```bash
    npx playwright test --update-snapshots
    ```

## 6. CI/CD

Наш CI-пайплайн в GitHub Actions выполняет следующие проверки для каждого Pull Request:

1.  `npm run lint`
2.  `npm run typecheck`
3.  `npm test` (все unit и интеграционные тесты)
4.  `npm run test:e2e` (все E2E-тесты в `TEST_MODE`)

**Мерж в `main` или `develop` возможен только при прохождении всех проверок.**
